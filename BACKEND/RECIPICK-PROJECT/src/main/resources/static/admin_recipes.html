<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin · 레시피/댓글 관리</title>
  <link rel="stylesheet" href="css/tokens.css" />
  <link rel="stylesheet" href="css/components.css" />
  <link rel="stylesheet" href="css/admin.css" />
  <link rel="stylesheet" href="css/admin_recipes.css" />
  <script defer src="js/theme.js"></script>
</head>
<body class="admin">
<div class="admin-layout">
  <!-- 사이드바 -->
  <aside class="side">
    <div class="logo">LOGO</div>
    <nav class="sidemenu">
      <a class="m" href="admin.html">대시보드</a>
      <a class="m" href="admin_reports.html">신고 관리</a>
      <a class="m active" href="admin_recipes.html">레시피/댓글 관리</a>
      <a class="m" href="admin_users.html">유저 관리</a>
      <a class="m" href="admin_settings.html">세팅</a>
    </nav>
  </aside>

  <!-- 보드 -->
  <main class="board">
    <div class="topbar">
      <h1>레시피 / 댓글 관리</h1>
      <div class="actions">
        <input class="input" type="search" placeholder="제목/작성자/내용 검색" />
        <button class="btn">검색</button>
      </div>
    </div>

    <!-- ▣ 규칙 요약 (세팅과 연동) -->
    <section class="card" aria-labelledby="ruleTitle">
      <h2 class="card-title" id="ruleTitle">승격 규칙 요약</h2>
      <p class="desc">세팅에서 정의한 임시→정식 기준입니다. (자동/수동, 기간/좋아요/저장/평점/참여/조회/쿨다운)</p>
      <div id="ruleSummary" class="desc" style="font-weight:700;">-</div>
    </section>

    <!-- 📌 레시피 게시글 (카드 리스트 + 승격 상태/버튼) -->
    <section class="card" aria-labelledby="recipesTitle">
      <h2 class="card-title" id="recipesTitle">레시피 게시글</h2>

      <div class="toolbar">
        <label class="chk"><input type="checkbox" id="checkAllPosts" /> 전체선택</label>
        <button class="btn-ghost" id="bulkPromote">선택 승격</button>
        <button class="btn-ghost" id="hidePosts">선택 비공개</button>
        <button class="btn-ghost" id="delPosts">선택 삭제</button>
      </div>

      <div class="post-list">
        <ul id="postList">
          <!-- 예시 아이템들: data-*에 지표를 넣어 승격 판단 -->
          <li class="item" data-id="r_550"
              data-likes="124" data-saves="60" data-rating="4.6" data-reviews="22" data-views="1500" data-days="5"
              data-status="temp">
            <div class="item-main">
              <div class="item-title">
                <span class="select-box">
                  <input type="checkbox" class="rowchk-post" />
                  <span>새송이 버터간장볶음</span>
                </span>
              </div>
              <div class="item-meta">
                <span>RID: r_550</span>
                <span>작성자: cook99</span>
                <span>등록일: 2025-08-10</span>
                <span>좋아요: 124</span>
                <span>저장: 60</span>
                <span>평점: 4.6(22)</span>
                <span>조회: 1500</span>
                <span>경과일: 5</span>
              </div>
            </div>
            <div class="item-right">
              <span class="badge warn status-badge">임시</span>
              <span class="promote-chip wait">대기</span>
              <button class="btn-ghost small promote-btn">승격</button>
              <a class="btn-ghost small" href="recipe-detail.html?id=550" target="_blank" rel="noopener">보기</a>
            </div>
          </li>

          <li class="item" data-id="r_551"
              data-likes="20" data-saves="8" data-rating="3.9" data-reviews="5" data-views="200" data-days="9"
              data-status="temp">
            <div class="item-main">
              <div class="item-title">
                <span class="select-box">
                  <input type="checkbox" class="rowchk-post" />
                  <span>간단 토스트</span>
                </span>
              </div>
              <div class="item-meta">
                <span>RID: r_551</span>
                <span>작성자: homecook</span>
                <span>등록일: 2025-08-06</span>
                <span>좋아요: 20</span>
                <span>저장: 8</span>
                <span>평점: 3.9(5)</span>
                <span>조회: 200</span>
                <span>경과일: 9</span>
              </div>
            </div>
            <div class="item-right">
              <span class="badge warn status-badge">임시</span>
              <span class="promote-chip wait">대기</span>
              <button class="btn-ghost small promote-btn">승격</button>
              <a class="btn-ghost small" href="recipe-detail.html?id=551" target="_blank" rel="noopener">보기</a>
            </div>
          </li>

          <li class="item" data-id="r_100"
              data-likes="230" data-saves="120" data-rating="4.8" data-reviews="88" data-views="12000" data-days="3"
              data-status="official">
            <div class="item-main">
              <div class="item-title">
                <span class="select-box">
                  <input type="checkbox" class="rowchk-post" />
                  <span>정식 레시피 예시</span>
                </span>
              </div>
              <div class="item-meta">
                <span>RID: r_100</span>
                <span>작성자: master</span>
                <span>등록일: 2025-08-12</span>
                <span>좋아요: 230</span>
                <span>저장: 120</span>
                <span>평점: 4.8(88)</span>
                <span>조회: 12000</span>
                <span>경과일: 3</span>
              </div>
            </div>
            <div class="item-right">
              <span class="badge ok status-badge">정식</span>
              <span class="promote-chip ok">충족</span>
              <button class="btn-ghost small promote-btn" disabled>승격</button>
              <a class="btn-ghost small" href="recipe-detail.html?id=100" target="_blank" rel="noopener">보기</a>
            </div>
          </li>
        </ul>
      </div>
    </section>

    <!-- 📌 댓글 / 리뷰 (그대로 유지) -->
    <section class="card" aria-labelledby="commentsTitle">
      <h2 class="card-title" id="commentsTitle">댓글 / 리뷰</h2>

      <div class="toolbar">
        <label class="chk"><input type="checkbox" id="checkAllComments" /> 전체선택</label>
        <button class="btn-ghost" id="delComments">선택 삭제</button>
      </div>

      <div class="comment-list">
        <ul id="commentList">
          <li class="item" data-id="c_901">
            <div class="item-main">
              <div class="item-title">
                <span class="select-box">
                  <input type="checkbox" class="rowchk-comment" />
                  <span>[r_550] 맛있어요 👍</span>
                </span>
              </div>
              <div class="item-meta">
                <span>CID: c_901</span>
                <span>작성자: user77</span>
                <span>작성일: 2025-08-20</span>
              </div>
            </div>
            <div class="item-right">
              <button class="btn-ghost small">삭제</button>
            </div>
          </li>
        </ul>
      </div>
    </section>
  </main>
</div>

<!-- (선택) 승격 확인 모달 -->
<div class="modal" id="promoteModal" aria-hidden="true">
  <div class="overlay" data-close></div>
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="promoteTitle">
    <div class="dialog-head">
      <h3 id="promoteTitle">승격 확인</h3>
      <button class="close" data-close aria-label="닫기">×</button>
    </div>
    <div class="dialog-body">
      <div id="promoteInfo">선택된 레시피를 정식으로 승격하시겠습니까?</div>
    </div>
    <div class="dialog-foot">
      <button class="btn-ghost" data-close>취소</button>
      <button class="btn success" id="confirmPromote">승격</button>
    </div>
  </div>
</div>

<script>
  (() => {
    // === 규칙 로드 (세팅에서 저장한 promotionRule 사용)
    const KEY = 'promotionRule';
    function readRule(){
      try{
        const raw = localStorage.getItem(KEY);
        return raw ? JSON.parse(raw) : null;
      }catch(e){ return null; }
    }
    function ruleSummaryText(r){
      if(!r) return '규칙이 없습니다. 세팅에서 먼저 정의하세요.';
      const parts = [];
      parts.push(r.mode === 'auto' ? '자동 승격' : '수동 승인');
      parts.push(`${r.windowDays}일 이내`);
      parts.push(`좋아요 ≥ ${r.minLikes}`);
      parts.push(`저장 ≥ ${r.minSaves}`);
      parts.push(`평점 ≥ ${r.minRating} (참여 ≥ ${r.minReviews})`);
      parts.push(`조회 ≥ ${r.minViews}`);
      if(+r.cooldown > 0) parts.push(`쿨다운 ${r.cooldown}시간`);
      return parts.join(' · ');
    }
    function qualifiesByRule(r, m){  // m: metrics
      if(!r) return false;
      if(r.mode === 'manual') return false; // 수동 모드면 자동 승격 불가(버튼은 남김)
      const fails = [];
      if(+m.days > +r.windowDays) fails.push('days');
      if(+m.likes < +r.minLikes) fails.push('likes');
      if(+m.saves < +r.minSaves) fails.push('saves');
      if(+m.rating < +r.minRating) fails.push('rating');
      if(+m.reviews < +r.minReviews) fails.push('reviews');
      if(+m.views < +r.minViews) fails.push('views');
      return fails.length === 0;
    }

    const rule = readRule();
    const summary = document.getElementById('ruleSummary');
    if(summary) summary.textContent = ruleSummaryText(rule);

    // === 레시피 카드 상태 반영
    document.querySelectorAll('#postList .item').forEach(li=>{
      const statusBadge = li.querySelector('.status-badge');
      const chip = li.querySelector('.promote-chip');
      const btn = li.querySelector('.promote-btn');

      const metrics = {
        likes: li.dataset.likes || 0,
        saves: li.dataset.saves || 0,
        rating: li.dataset.rating || 0,
        reviews: li.dataset.reviews || 0,
        views: li.dataset.views || 0,
        days: li.dataset.days || 0
      };

      const isOfficial = (li.dataset.status === 'official');
      if(isOfficial){
        statusBadge?.classList.remove('warn'); statusBadge?.classList.add('ok');
        statusBadge.textContent = '정식';
        chip?.classList.remove('wait'); chip?.classList.add('ok');
        chip.textContent = '충족';
        btn.disabled = true;
        return;
      }

      // 임시 상태
      statusBadge?.classList.remove('ok'); statusBadge?.classList.add('warn');
      statusBadge.textContent = '임시';

      // 규칙 충족 여부
      const ok = qualifiesByRule(rule, metrics);
      if(ok){
        chip?.classList.remove('wait'); chip?.classList.add('ok');
        chip.textContent = '승격 가능';
        btn.disabled = false;
      }else{
        chip?.classList.remove('ok'); chip?.classList.add('wait');
        chip.textContent = '대기';
        btn.disabled = false; // 수동모드나 관리자가 강제 승격할 수 있도록 버튼은 열어둠
      }

      // 버튼 클릭 → 확인 모달
      btn?.addEventListener('click', ()=>{
        openPromoteModal([li.dataset.id], metrics, ok);
      });
    });

    // === 전체선택/일괄
    const allPosts = document.getElementById('checkAllPosts');
    allPosts?.addEventListener('change', () => {
      document.querySelectorAll('.rowchk-post').forEach(chk => chk.checked = allPosts.checked);
    });

    document.getElementById('hidePosts')?.addEventListener('click', ()=> alert('선택 레시피 비공개 (더미)'));
    document.getElementById('delPosts')?.addEventListener('click', ()=> alert('선택 레시피 삭제 (더미)'));

    // 일괄 승격
    document.getElementById('bulkPromote')?.addEventListener('click', ()=>{
      const ids = [];
      document.querySelectorAll('#postList .item').forEach(li=>{
        const chk = li.querySelector('.rowchk-post');
        if(chk?.checked) ids.push(li.dataset.id);
      });
      if(ids.length === 0) return alert('선택된 레시피가 없습니다.');
      openPromoteModal(ids, null, null);
    });

    // === 모달
    const modal = document.getElementById('promoteModal');
    const info = document.getElementById('promoteInfo');
    const confirmBtn = document.getElementById('confirmPromote');

    function openPromoteModal(ids, m, ok){
      const title = ids.length === 1 ? ids[0] : `${ids.length}개 레시피`;
      let lines = [`<strong>${title}</strong>을(를) 정식으로 승격하시겠습니까?`];
      if(m){
        lines.push(`<div style="margin-top:6px; font-size:13px; color:var(--muted)">
        likes ${m.likes}, saves ${m.saves}, rating ${m.rating}(${m.reviews}), views ${m.views}, days ${m.days}
      </div>`);
        if(rule){
          lines.push(`<div style="margin-top:6px; font-size:13px; color:${ok ? 'var(--green-700)' : '#E53935'}">
          규칙 판정: ${ok ? '충족' : '미충족 (수동 가능)'}
        </div>`);
        }
      }
      info.innerHTML = lines.join('');
      modal.setAttribute('aria-hidden','false');
      document.documentElement.style.overflow = 'hidden';

      confirmBtn.onclick = ()=>{
        modal.setAttribute('aria-hidden','true');
        document.documentElement.style.overflow = '';
        alert(`승격 처리(더미): ${ids.join(', ')}`);
        // TODO: 백엔드 연동 시 POST /admin/recipes/promote { ids }
        // 성공 후 UI 업데이트(뱃지 '정식', 칩 '충족', 버튼 disabled 등) 필요
      };
    }

    document.querySelectorAll('[data-close]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        btn.closest('.modal').setAttribute('aria-hidden','true');
        document.documentElement.style.overflow = '';
      });
    });

    // === 댓글 섹션
    const allComments = document.getElementById('checkAllComments');
    allComments?.addEventListener('change', () => {
      document.querySelectorAll('.rowchk-comment').forEach(chk => chk.checked = allComments.checked);
    });
    document.getElementById('delComments')?.addEventListener('click', ()=> alert('선택 댓글 삭제 (더미)'));
  })();
</script>
</body>
</html>
