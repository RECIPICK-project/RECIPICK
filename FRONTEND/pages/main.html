<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>RECIPICK Â· ë©”ì¸</title>

  <!-- ê¸°ì¡´ CSS -->
  <link rel="stylesheet" href="../css/tokens.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <link rel="stylesheet" href="../css/main.css" />

</head>

<body>
  <main class="phone" role="main" aria-label="ë©”ì¸ í™”ë©´">

    <!-- í—¤ë” -->
    <header class="top">
      <h1 class="logo">RECIPICK</h1>
      <button class="notif" aria-label="ì•Œë¦¼">
        <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 17h5l-1.4-1.4A2 2 0 0 1 18 14.2V11a6 6 0 0 0-12 0v3.2c0 .5-.2 1-.6 1.4L4 17h5" />
          <path d="M10 21a2 2 0 0 0 4 0" />
        </svg>
      </button>
    </header>

    <!-- ê²€ìƒ‰ -->
    <section class="search">
      <form class="search-row" action="search.html" method="get">
        <svg class="icon" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#6b7280" stroke-width="2">
          <circle cx="11" cy="11" r="7"></circle>
          <path d="M20 20l-3.5-3.5"></path>
        </svg>
        <input class="search-input" type="search" name="q" placeholder="ë ˆì‹œí”¼, ì¬ë£Œ, íƒœê·¸ ê²€ìƒ‰" autocomplete="off" />
        <button class="filter" type="button" onclick="location.href='filter.html'">í•„í„°</button>
      </form>
    </section>

    <!-- ì˜¤ëŠ˜ì˜ ì¶”ì²œ -->
    <section class="section" id="featuredSection">
      <div class="sec-head">
        <h2>ì˜¤ëŠ˜ì˜ ì¶”ì²œ</h2>
        <a class="more" href="search.html?sort=hot">ë”ë³´ê¸°</a>
      </div>

      <div class="hero is-17x" id="hero">
        <div class="slides" id="slides" aria-live="polite"></div>
        <div class="dots" role="tablist" aria-label="ì¶”ì²œ ìŠ¬ë¼ì´ë“œ"></div>
      </div>
    </section>

    <!-- ì¬ë£Œ -->
    <section class="category-section">
      <div class="sec-head">
        <h2>ì¬ë£Œ</h2>
      </div>
      <div class="category-grid" id="categoryGrid"></div>
    </section>

    <!-- ì¸ê¸° -->
    <section class="section">
      <div class="sec-head">
        <h2>ì¸ê¸° ë ˆì‹œí”¼</h2>
        <div class="sort">
          <button class="pill is-active">ì¸ê¸°</button>
          <button class="pill">ìµœì‹ </button>
          <button class="pill">ë³„ì </button>
        </div>
      </div>
      <div class="grid" id="grid"></div>
    </section>

    <nav class="tabbar" aria-label="í•˜ë‹¨ íƒ­ë°”">
      <!-- ë©”ë‰´: ì‹œíŠ¸ ì—´ê¸° -->
      <button class="tab" type="button" aria-label="ë©”ë‰´" onclick="toggleSlideMenu()">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#6b7280" stroke-width="2">
          <path d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>

      <!-- ì¢‹ì•„ìš” -->
      <a class="tab is-active" href="liked.html" aria-label="ì¢‹ì•„ìš”">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="#2E7D32">
          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5
               2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09
               C13.09 3.81 14.76 3 16.5 3
               19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55
               11.54L12 21.35z" />
        </svg>
      </a>

      <!-- ê²€ìƒ‰ -->
      <a class="tab" href="search.html" aria-label="ê²€ìƒ‰">
        <div class="ring">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="#6b7280" stroke-width="2">
            <circle cx="11" cy="11" r="7" />
            <path d="M20 20l-3.5-3.5" />
          </svg>
        </div>
      </a>

      <!-- ì¶”ê°€ -->
      <a class="tab" href="post_upload.html" aria-label="ì¶”ê°€">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#6b7280" stroke-width="2">
          <path d="M12 5v14M5 12h14" />
        </svg>
      </a>

      <!-- í”„ë¡œí•„ -->
      <a class="tab" href="profile.html" aria-label="í”„ë¡œí•„">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#6b7280" stroke-width="2">
          <circle cx="12" cy="8" r="4" />
          <path d="M4 20c2-4 14-4 16 0" />
        </svg>
      </a>
    </nav>


  </main>
  <!-- â–¼ ì¶”ê°€: ìŠ¬ë¼ì´ë“œ ì—… ë©”ë‰´ -->
  <div class="slide-menu" id="slideMenu">
    <div class="slide-menu-overlay"></div>
    <div class="slide-menu-content">
      <div class="slide-menu-header">
        <h2>ë©”ë‰´</h2>
        <button class="close-menu-btn" onclick="closeSlideMenu()">
          <svg viewBox="0 0 24 24" width="20" height="20">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" fill="none" />
          </svg>
        </button>
      </div>
      <div class="slide-menu-items">
        <div class="menu-item" onclick="location.href='profile.html'">
          <svg class="menu-icon" viewBox="0 0 24 24">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
            <circle cx="12" cy="7" r="4" />
          </svg>
          <span>ë§ˆì´í˜ì´ì§€</span>
        </div>
        <div class="menu-item" onclick="location.href='recipes.html'">
          <svg class="menu-icon" viewBox="0 0 24 24">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <polyline points="14,2 14,8 20,8" />
          </svg>
          <span>ì •ì‹ ë ˆì‹œí”¼ ì¡°íšŒ</span>
        </div>
        <div class="menu-item" onclick="location.href='liked.html'">
          <svg class="menu-icon" viewBox="0 0 24 24">
            <path
              d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
          </svg>
          <span>ì¢‹ì•„ìš”í•œ ë ˆì‹œí”¼ ì¡°íšŒ</span>
        </div>
        <div class="menu-item" onclick="location.href='settings.html'">
          <svg class="menu-icon" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="3" />
            <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1m11 7.5a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" />
          </svg>
          <span>ì„¤ì •</span>
        </div>
        <div class="menu-item logout" onclick="/* TODO: logout() ì—°ê²° */">
          <svg class="menu-icon" viewBox="0 0 24 24">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
            <polyline points="16,17 21,12 16,7" />
            <line x1="21" y1="12" x2="9" y2="12" />
          </svg>
          <span>ë¡œê·¸ì•„ì›ƒ</span>
        </div>
      </div>
    </div>
  </div>


  <!-- ===== ìŠ¤í¬ë¦½íŠ¸ (ì¤‘ë³µ ì„ ì–¸ ì—†ìŒ) ===== -->
  <script>
    const BASE = 'http://localhost:8080';
    const PAGES = BASE + '/pages';
    const PLACEHOLDER = 'https://placehold.co/1200x800?text=RECIPICK';

    /* URL ìœ í‹¸ */
    function toAbs(u) {
      if (!u) return null;
      if (/^https?:\/\//i.test(u)) return u;
      if (u.startsWith('/')) return BASE + u;
      return `${BASE}/uploads/${u}`;
    }
    function safeEncode(raw) { return encodeURIComponent(String(raw).trim()).replace(/%5C/gi, ''); }
    function proxyUrl(abs) { return abs ? `${BASE}/img-proxy?u=${safeEncode(abs)}` : null; }

    /* ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ */
    function testImage(url) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
        img.referrerPolicy = 'no-referrer';
        img.src = url;
      });
    }
    async function pickWorkingImage(raw) {
      const direct = toAbs(raw);
      const candidates = [proxyUrl(direct), direct, PLACEHOLDER].filter(Boolean);
      for (const u of candidates) if (await testImage(u)) return u;
      return PLACEHOLDER;
    }

    /* ì¬ë£Œ ì¹´í…Œê³ ë¦¬ ë Œë” */
    (function renderCategories() {
      const categories = [
        { name: 'ì†Œê³ ê¸°', icon: 'ğŸ¥©' }, { name: 'ë¼ì§€ê³ ê¸°', icon: 'ğŸ–' }, { name: 'ë‹­ê³ ê¸°', icon: 'ğŸ—' },
        { name: 'ë‹¬ê±€/ìœ ì œí’ˆë¥˜', icon: 'ğŸ¥š' }, { name: 'ê³¡ë¥˜', icon: 'ğŸŒ¾' },
        { name: 'ê³¼ì¼ë¥˜', icon: 'ğŸ' }, { name: 'ê°€ê³µì‹í’ˆë¥˜', icon: 'ğŸ¥«' }, { name: 'ê±´ì–´ë¬¼ë¥˜', icon: 'ğŸŸ' },
        { name: 'ë²„ì„¯ë¥˜', icon: 'ğŸ„' }, { name: 'ë°€ê°€ë£¨', icon: 'ğŸ§‚' }, { name: 'ê³¡ë¥˜', icon: 'ğŸš' },
        { name: 'ì±„ì†Œë¥˜', icon: 'ğŸ¥¦' }, { name: 'ì½©/ê²¬ê³¼ë¥˜', icon: 'ğŸ¥œ' }, { name: 'í•´ë¬¼ë¥˜', icon: 'ğŸ¦' },
      ];
      const grid = document.getElementById('categoryGrid');
      if (!grid) return;
      grid.innerHTML = categories.map(c => `
    <a class="category-item" href="${PAGES}/search_home.html?category=${encodeURIComponent(c.name)}" aria-label="${c.name}">
      <div class="cat-badge" aria-hidden="true">${c.icon}</div>
      <div class="category-name">${c.name}</div>
    </a>
  `).join('');
    })();

    /* ì •ë ¬ í† ê¸€ */
    document.querySelectorAll('.pill').forEach(p => {
      p.addEventListener('click', () => {
        document.querySelectorAll('.pill').forEach(x => x.classList.remove('is-active'));
        p.classList.add('is-active');
      });
    });

    /* ìºëŸ¬ì…€ ì œì–´ */
    let currentSlide = 0, totalSlides = 0, autoSlideInterval;
    function updateSlide() {
      const slides = document.getElementById('slides');
      const dots = document.querySelectorAll('.dot');
      slides.style.transform = `translateX(-${currentSlide * 100}%)`;
      dots.forEach((d, i) => d.classList.toggle('is-active', i === currentSlide));
    }
    function nextSlide() { if (totalSlides > 0) { currentSlide = (currentSlide + 1) % totalSlides; updateSlide(); } }
    function goToSlide(i) { currentSlide = i; updateSlide(); resetAutoSlide(); }
    function resetAutoSlide() { clearInterval(autoSlideInterval); if (totalSlides > 1) { autoSlideInterval = setInterval(nextSlide, 4000); } }

    /* ì˜¤ëŠ˜ì˜ ì¶”ì²œ */
    (async () => {
      try {
        const r = await fetch(`${BASE}/api/main/today`, { cache: 'no-store' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        let list = await r.json();
        if (!Array.isArray(list) || !list.length) {
          list = [{ id: 0, title: 'ì¶”ì²œ ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤', foodName: '', rcpImgUrl: null, likeCount: 0, viewCount: 0 }];
        }
        const slidesEl = document.getElementById('slides');
        slidesEl.innerHTML = list.map((it, i) => {
          const id = it.id ?? it.post_id ?? it.postId ?? '';
          const href = `${PAGES}/post_detail.html${id ? `?id=${id}` : ''}`;
          return `
        <article class="slide" data-i="${i}">
        <a href="${href}" class="hero-link">
        <div class="hero-thumb"></div>
        <div class="hero-meta">
          <div class="hero-title">${it.title}</div>
          <div class="hero-sub">â¤ï¸ ${it.likeCount} Â· ğŸ‘ï¸ ${it.viewCount}</div>
        </div>
      </a>
      </article>
      `;
        }).join('');

        await Promise.all(list.map(async (it, idx) => {
          const good = await pickWorkingImage(it.rcpImgUrl);
          slidesEl.querySelector(`.slide[data-i="${idx}"] .hero-thumb`).style.backgroundImage = `url('${good}')`;
        }));

        const dotsWrap = document.querySelector('.dots');
        dotsWrap.innerHTML = list.map((_, i) =>
          `<button class="dot ${i === 0 ? 'is-active' : ''}" data-i="${i}" aria-label="${i + 1}ë²ˆ"></button>`
        ).join('');
        document.querySelectorAll('.dot').forEach((d, i) => d.addEventListener('click', () => goToSlide(i)));
        totalSlides = list.length;
        currentSlide = 0;
        updateSlide();
        resetAutoSlide();
      } catch (err) {
        console.error('[featured] load failed:', err);
        const slides = document.getElementById('slides');
        slides.innerHTML = `
      <article class="slide">
        <div class="hero-thumb" style="background-image:url('${PLACEHOLDER}')"></div>
        <div class="hero-meta">
          <div class="hero-title">ì¶”ì²œì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”</div>
          <div class="hero-sub">ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” ë°ì´í„° ë¬¸ì œì¼ ìˆ˜ ìˆì–´ìš”</div>
        </div>
      </article>`;
        document.querySelector('.dots').innerHTML = `<button class="dot is-active" data-i="0" aria-label="1ë²ˆ"></button>`;
        totalSlides = 1; currentSlide = 0; updateSlide();
      }
    })();

    /* ì¸ê¸° ë ˆì‹œí”¼ */
    (async () => {
      try {
        const r = await fetch(`${BASE}/api/main/popular-grid`, { cache: 'no-store' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const items = await r.json();
        const list = Array.isArray(items) && items.length ? items : [{
          id: 0, title: 'ìƒ˜í”Œ ë ˆì‹œí”¼', foodName: '', rcpImgUrl: null, likeCount: 0, viewCount: 0
        }];

        const grid = document.getElementById('grid');
        grid.innerHTML = list.map((it, i) => {
          const id = it.id ?? it.post_id ?? it.postId ?? '';
          const href = `${PAGES}/post_detail.html${id ? `?id=${id}` : ''}`;
          return `
        <a class="card" href="${href}" data-i="${i}">
          <div class="thumb"></div>
          <div class="meta">
            <div class="title">${it.title}</div>
            <div class="sub">â¤ï¸ ${it.likeCount} Â· ğŸ‘ï¸ ${it.viewCount}</div>
          </div>
        </a>`;
        }).join('');
        await Promise.all(list.map(async (it, idx) => {
          const good = await pickWorkingImage(it.rcpImgUrl);
          grid.querySelector(`.card[data-i="${idx}"] .thumb`).style.backgroundImage = `url('${good}')`;
        }));
      } catch (err) {
        console.error('[popular] load failed:', err);
      }
    })();
  </script>

  <script>
    /* â–¼ ì¶”ê°€: ìŠ¬ë¼ì´ë“œ ë©”ë‰´ í† ê¸€ ë°•ìŠ¤ë§Œ (ê¸°ì¡´ ì½”ë“œ ì†ëŒ€ì§€ ë§ê³  ë§¨ ì•„ë˜ ë¶™ì´ê¸°) */
    function openSlideMenu() {
      const sheet = document.getElementById('slideMenu');
      if (!sheet) return;
      sheet.style.visibility = 'visible';
      sheet.style.opacity = '1';
      requestAnimationFrame(() => {
        sheet.classList.add('active');
        document.body.style.overflow = 'hidden';
      });
    }
    function closeSlideMenu() {
      const sheet = document.getElementById('slideMenu');
      if (!sheet) return;
      sheet.classList.remove('active');
      document.body.style.overflow = '';
      setTimeout(() => {
        if (!sheet.classList.contains('active')) {
          sheet.style.opacity = '0';
          sheet.style.visibility = 'hidden';
        }
      }, 300);
    }
    function toggleSlideMenu() {
      const sheet = document.getElementById('slideMenu');
      if (!sheet) return;
      sheet.classList.contains('active') ? closeSlideMenu() : openSlideMenu();
    }

    document.addEventListener('DOMContentLoaded', () => {
      const sheet = document.getElementById('slideMenu');
      if (sheet) {
        const overlay = sheet.querySelector('.slide-menu-overlay');
        if (overlay) overlay.addEventListener('click', closeSlideMenu);
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSlideMenu(); });
      }
      /* íƒ­ë°”ì˜ 'ë©”ë‰´' aíƒœê·¸ í´ë¦­ì„ ê°€ë¡œì±„ì„œ ì‹œíŠ¸ë¥¼ ì—´ê¸° (ê¸°ì¡´ a ìœ ì§€) */
      const tabbar = document.querySelector('.tabbar');
      if (tabbar) {
        tabbar.addEventListener('click', (e) => {
          const tab = e.target.closest('.tab');
          if (!tab) return;
          const isMenu = (tab.getAttribute('aria-label') || '').includes('ë©”ë‰´');
          if (isMenu) {
            e.preventDefault(); // menu.html ì´ë™ ë§‰ê³ 
            toggleSlideMenu();  // ì‹œíŠ¸ ì—´ê¸°
          }
        });
      }
    });
  </script>


</body>

</html>
