<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>RECIPICK · 메인</title>

  <!-- 기존 CSS -->
  <link rel="stylesheet" href="../css/tokens.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <link rel="stylesheet" href="../css/main.css" />

  <script src="../js/common_tabbar.js" defer></script>

</head>

<body>
  <main class="phone" role="main" aria-label="메인 화면">

    <!-- 헤더 -->
    <header class="top">
      <h1 class="logo">RECIPICK</h1>
      <button class="notif" aria-label="알림">
        <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 17h5l-1.4-1.4A2 2 0 0 1 18 14.2V11a6 6 0 0 0-12 0v3.2c0 .5-.2 1-.6 1.4L4 17h5" />
          <path d="M10 21a2 2 0 0 0 4 0" />
        </svg>
      </button>
    </header>

    <!-- 검색 -->
    <section class="search">
      <form class="search-row" action="search_home.html" method="get">
        <input class="search-input" type="search" name="q" placeholder="레시피, 재료, 태그 검색" autocomplete="off" />
        <button class="btn-go" type="submit">검색</button>
      </form>
    </section>

    <!-- 오늘의 추천 -->
    <section class="section" id="featuredSection">
      <div class="sec-head">
        <h2>오늘의 추천</h2>
        <a class="more" href="search_home.html?sort=hot">더보기</a>
      </div>

      <div class="hero is-17x" id="hero">
        <div class="slides" id="slides" aria-live="polite"></div>
        <div class="dots" role="tablist" aria-label="추천 슬라이드"></div>
      </div>
    </section>

    <!-- 재료 -->
    <section class="category-section">
      <div class="sec-head">
        <h2>재료</h2>
      </div>
      <div class="category-grid" id="categoryGrid"></div>
    </section>

    <!-- 인기 -->
    <section class="section">
      <div class="sec-head">
        <h2>인기 레시피</h2>
        <div class="sort">
          <button class="pill is-active">인기</button>
          <button class="pill">최신</button>
          <button class="pill">별점</button>
        </div>
      </div>
      <div class="grid" id="grid"></div>

    </section>
  </main>
  <!-- ===== 스크립트 (중복 선언 없음) ===== -->
  <script>
    const BASE = '';
    const PAGES = BASE + '/pages';
    const PLACEHOLDER = 'https://placehold.co/1200x800?text=RECIPICK';

    /* URL 유틸 */
    function toAbs(u) {
      if (!u) return null;
      if (/^https?:\/\//i.test(u)) return u;
      if (u.startsWith('/')) return BASE + u;
      return `${BASE}/uploads/${u}`;
    }
    function safeEncode(raw) { return encodeURIComponent(String(raw).trim()).replace(/%5C/gi, ''); }
    function proxyUrl(abs) { return abs ? `${BASE}/img-proxy?u=${safeEncode(abs)}` : null; }

    /* 이미지 프리로드 */
    function testImage(url) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
        img.referrerPolicy = 'no-referrer';
        img.src = url;
      });
    }
    async function pickWorkingImage(raw) {
      const direct = toAbs(raw);
      const candidates = [direct, PLACEHOLDER].filter(Boolean);
      for (const u of candidates) if (await testImage(u)) return u;
      return PLACEHOLDER;
    }

    /* 재료 카테고리 렌더 */
    (function renderCategories() {
      const categories = [
        { name: '소고기', icon: '🥩' }, { name: '돼지고기', icon: '🍖' }, { name: '닭고기', icon: '🍗' },
        { name: '달걀/유제품류', icon: '🥚' }, { name: '곡류', icon: '🌾' },
        { name: '과일류', icon: '🍎' }, { name: '가공식품류', icon: '🥫' }, { name: '건어물류', icon: '🐟' },
        { name: '버섯류', icon: '🍄' }, { name: '밀가루', icon: '🧂' }, { name: '곡류', icon: '🍚' },
        { name: '채소류', icon: '🥦' }, { name: '콩/견과류', icon: '🥜' }, { name: '해물류', icon: '🦐' },
      ];
      const grid = document.getElementById('categoryGrid');
      if (!grid) return;
      grid.innerHTML = categories.map(c => `
    <a class="category-item" href="${PAGES}/search_home.html?category=${encodeURIComponent(c.name)}" aria-label="${c.name}">
      <div class="cat-badge" aria-hidden="true">${c.icon}</div>
      <div class="category-name">${c.name}</div>
    </a>
  `).join('');
    })();

    /* 정렬 토글 */
    document.querySelectorAll('.pill').forEach(p => {
      p.addEventListener('click', () => {
        document.querySelectorAll('.pill').forEach(x => x.classList.remove('is-active'));
        p.classList.add('is-active');
      });
    });

    /* 캐러셀 제어 */
    let currentSlide = 0, totalSlides = 0, autoSlideInterval;
    function updateSlide() {
      const slides = document.getElementById('slides');
      const dots = document.querySelectorAll('.dot');
      slides.style.transform = `translateX(-${currentSlide * 100}%)`;
      dots.forEach((d, i) => d.classList.toggle('is-active', i === currentSlide));
    }
    function nextSlide() { if (totalSlides > 0) { currentSlide = (currentSlide + 1) % totalSlides; updateSlide(); } }
    function goToSlide(i) { currentSlide = i; updateSlide(); resetAutoSlide(); }
    function resetAutoSlide() { clearInterval(autoSlideInterval); if (totalSlides > 1) { autoSlideInterval = setInterval(nextSlide, 4000); } }

    /* 오늘의 추천 */
    (async () => {
      try {
        const r = await fetch(`${BASE}/api/main/today`, { cache: 'no-store' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        let list = await r.json();
        if (!Array.isArray(list) || !list.length) {
          list = [{ id: 0, title: '추천 레시피가 없습니다', foodName: '', rcpImgUrl: null, likeCount: 0, viewCount: 0 }];
        }
        const slidesEl = document.getElementById('slides');
        slidesEl.innerHTML = list.map((it, i) => {
          const id = it.postId ?? it.id ?? it.post_id;
          const href = id ? `/post_detail/${id}` : 'javascript:void(0)';
          return `
        <article class="slide" data-i="${i}">
        <a href="${href}" class="hero-link">
        <div class="hero-thumb"></div>
        <div class="hero-meta">
          <div class="hero-title">${it.title}</div>
          <div class="hero-sub">❤️ ${it.likeCount} · 👁️ ${it.viewCount}</div>
        </div>
      </a>
      </article>
      `;
        }).join('');

        await Promise.all(list.map(async (it, idx) => {
          const good = await pickWorkingImage(it.rcpImgUrl);
          slidesEl.querySelector(`.slide[data-i="${idx}"] .hero-thumb`).style.backgroundImage = `url('${good}')`;
        }));

        const dotsWrap = document.querySelector('.dots');
        dotsWrap.innerHTML = list.map((_, i) =>
          `<button class="dot ${i === 0 ? 'is-active' : ''}" data-i="${i}" aria-label="${i + 1}번"></button>`
        ).join('');
        document.querySelectorAll('.dot').forEach((d, i) => d.addEventListener('click', () => goToSlide(i)));
        totalSlides = list.length;
        currentSlide = 0;
        updateSlide();
        resetAutoSlide();
      } catch (err) {
        console.error('[featured] load failed:', err);
        const slides = document.getElementById('slides');
        slides.innerHTML = `
      <article class="slide">
        <div class="hero-thumb" style="background-image:url('${PLACEHOLDER}')"></div>
        <div class="hero-meta">
          <div class="hero-title">추천을 불러오지 못했어요</div>
          <div class="hero-sub">네트워크 또는 데이터 문제일 수 있어요</div>
        </div>
      </article>`;
        document.querySelector('.dots').innerHTML = `<button class="dot is-active" data-i="0" aria-label="1번"></button>`;
        totalSlides = 1; currentSlide = 0; updateSlide();
      }
    })();

    /* 인기 레시피 */
    (async () => {
      try {
        const r = await fetch(`${BASE}/api/main/popular-grid`, { cache: 'no-store' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const items = await r.json();
        const list = Array.isArray(items) && items.length ? items : [{
          id: 0, title: '샘플 레시피', foodName: '', rcpImgUrl: null, likeCount: 0, viewCount: 0
        }];

        const grid = document.getElementById('grid');
        grid.innerHTML = list.map((it, i) => {
          const id = it.postId ?? it.id ?? it.post_id;
          const href = id ? `/post_detail/${id}` : 'javascript:void(0)';
          return `
        <a class="card" href="${href}" data-i="${i}">
          <div class="thumb"></div>
          <div class="meta">
            <div class="title">${it.title}</div>
            <div class="sub">❤️ ${it.likeCount} · 👁️ ${it.viewCount}</div>
          </div>
        </a>`;
        }).join('');
        await Promise.all(list.map(async (it, idx) => {
          const good = await pickWorkingImage(it.rcpImgUrl);
          grid.querySelector(`.card[data-i="${idx}"] .thumb`).style.backgroundImage = `url('${good}')`;
        }));
      } catch (err) {
        console.error('[popular] load failed:', err);
      }
    })();
  </script>

  <script>
    /* ▼ 추가: 슬라이드 메뉴 토글 박스만 (기존 코드 손대지 말고 맨 아래 붙이기) */
    function openSlideMenu() {
      const sheet = document.getElementById('slideMenu');
      if (!sheet) return;
      sheet.style.visibility = 'visible';
      sheet.style.opacity = '1';
      requestAnimationFrame(() => {
        sheet.classList.add('active');
        document.body.style.overflow = 'hidden';
      });
    }
    function closeSlideMenu() {
      const sheet = document.getElementById('slideMenu');
      if (!sheet) return;
      sheet.classList.remove('active');
      document.body.style.overflow = '';
      setTimeout(() => {
        if (!sheet.classList.contains('active')) {
          sheet.style.opacity = '0';
          sheet.style.visibility = 'hidden';
        }
      }, 300);
    }
    function toggleSlideMenu() {
      const sheet = document.getElementById('slideMenu');
      if (!sheet) return;
      sheet.classList.contains('active') ? closeSlideMenu() : openSlideMenu();
    }

    document.addEventListener('DOMContentLoaded', () => {
      const sheet = document.getElementById('slideMenu');
      if (sheet) {
        const overlay = sheet.querySelector('.slide-menu-overlay');
        if (overlay) overlay.addEventListener('click', closeSlideMenu);
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSlideMenu(); });
      }
      /* 탭바의 '메뉴' a태그 클릭을 가로채서 시트를 열기 (기존 a 유지) */
      const tabbar = document.querySelector('.tabbar');
      if (tabbar) {
        tabbar.addEventListener('click', (e) => {
          const tab = e.target.closest('.tab');
          if (!tab) return;
          const isMenu = (tab.getAttribute('aria-label') || '').includes('메뉴');
          if (isMenu) {
            e.preventDefault(); // menu.html 이동 막고
            toggleSlideMenu();  // 시트 열기
          }
        });
      }
    });
  </script>
  <script>
    // 🔎 검색 입력값을 카테고리로 인식하면 category 파라미터로 리다이렉트
    (function enableCategorySmartSearch() {
      const form = document.querySelector('form.search-row');
      const input = document.querySelector('.search-input');
      if (!form || !input) return;

      // 현재 페이지 상단에서 렌더에 쓰던 카테고리 목록과 동기화 (필요 시 추가)
      const CATEGORIES = [
        '소고기', '돼지고기', '닭고기', '달걀/유제품류', '곡류', '과일류', '가공식품류',
        '건어물류', '버섯류', '밀가루', '채소류', '콩/견과류', '해물류'
      ];

      // 간단 동의어/영문 매핑 (원하면 계속 추가하세요)
      const SYNONYM = {
        'beef': '소고기',
        '소': '소고기',
        '한우': '소고기',
        'pork': '돼지고기',
        'chicken': '닭고기',
        'egg': '달걀/유제품류',
        'eggs': '달걀/유제품류',
        'dairy': '달걀/유제품류',
        'grain': '곡류',
        'grains': '곡류',
        'fruit': '과일류',
        'fruits': '과일류',
        'mushroom': '버섯류',
        'mushrooms': '버섯류',
        'seafood': '해물류',
        'nut': '콩/견과류',
        'nuts': '콩/견과류',
        'flour': '밀가루',
        'veggie': '채소류',
        'veggies': '채소류',
        'vegetable': '채소류',
        'vegetables': '채소류',
      };

      const norm = (s) => String(s || '')
        .trim()
        .toLowerCase()
        .replace(/\s+/g, '');

      // 카테고리 셋/매핑 준비
      const catSet = new Set(CATEGORIES.map(norm));
      const synMap = new Map(Object.entries(SYNONYM).map(([k, v]) => [norm(k), v]));

      form.addEventListener('submit', (e) => {
        const raw = input.value || '';
        const n = norm(raw);
        if (!n) return; // 빈 검색은 기본 action 그대로 진행

        // 1) 동의어 매핑이 있으면 그 카테고리로
        let category = synMap.get(n);

        // 2) 사용자가 카테고리 이름을 그대로 쳤다면 그걸로
        if (!category && catSet.has(n)) {
          // 원래 형태(대소문자/띄어쓰기) 보존 위해 CATEGORIES에서 찾아 매칭
          category = CATEGORIES.find((c) => norm(c) === n);
        }

        // 라우팅
        if (category) {
          e.preventDefault();
          // 상단에서 쓰던 상수와 동일하게 사용 (PAGES가 정의돼 있으면 그대로 사용)
          const target = (typeof PAGES !== 'undefined' ? PAGES : '') + `/search_home.html?category=${encodeURIComponent(category)}`;
          location.href = target;
        } else {
          // 일반 검색어는 기존처럼 q 파라미터로
          // form.action이 상대경로라면 PAGES 기준으로 바꿔주는 게 안전
          e.preventDefault();
          const base = (typeof PAGES !== 'undefined' ? PAGES : '');
          location.href = `${base}/search_home.html?searchType=title&q=${encodeURIComponent(raw)}`;
        }
      });
    })();
  </script>



</body>

</html>
