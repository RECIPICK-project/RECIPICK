<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>회원가입</title>
</head>
<body>
<h1>회원가입</h1>

<form id="signupForm">
    이메일:
    <input type="email" id="email" required>
    <button type="button" id="checkEmailBtn">중복 확인</button>
    <span id="emailMsg"></span>
    <br>

    비밀번호: <input type="password" id="password" required><br>
    비밀번호 확인: <input type="password" id="confirmPassword" required><br>

    닉네임:
    <input type="text" id="nickname" required>
    <button type="button" id="checkNicknameBtn">중복 확인</button>
    <span id="nicknameMsg"></span>
    <br>

    <button type="submit">회원가입</button>
</form>

<!-- 이메일 인증 -->
<div id="emailVerification" style="display:none; margin-top:20px;">
    <p>이메일로 발송된 6자리 코드를 입력하세요.</p>
    <input type="text" id="verificationCode" maxlength="6">
    <button type="button" id="verifyBtn">인증 확인</button>
    <span id="verifyMsg"></span>
</div>

<p id="errorMsg" style="color:red;"></p>

<script>
    const BASE_API = "http://localhost:9999";

    const emailInput = document.getElementById("email");
    const emailMsg = document.getElementById("emailMsg");
    const checkEmailBtn = document.getElementById("checkEmailBtn");
    let isEmailValid = false;

    const nicknameInput = document.getElementById("nickname");
    const nicknameMsg = document.getElementById("nicknameMsg");
    const checkNicknameBtn = document.getElementById("checkNicknameBtn");
    let isNicknameValid = false;

    const errorMsg = document.getElementById("errorMsg");

    // ===== 이메일 중복 확인 =====
    checkEmailBtn.addEventListener("click", async () => {
      const email = emailInput.value.trim().toLowerCase();
      emailMsg.textContent = "";
      isEmailValid = false;

      if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
        emailMsg.textContent = "올바른 이메일 형식이 아닙니다.";
        emailMsg.style.color = "red";
        return;
      }

      try {
        const res = await fetch(`${BASE_API}/api/users/check-email?email=${encodeURIComponent(email)}`);
        const data = await res.json();
        if (data.exists) {
          emailMsg.textContent = "이미 사용 중인 이메일입니다.";
          emailMsg.style.color = "red";
          isEmailValid = false;
        } else {
          emailMsg.textContent = "사용 가능한 이메일입니다.";
          emailMsg.style.color = "green";
          isEmailValid = true;
        }
      } catch (e) {
        console.error(e);
        emailMsg.textContent = "서버 오류";
        emailMsg.style.color = "red";
      }
    });

    // ===== 닉네임 중복 확인 =====
    checkNicknameBtn.addEventListener("click", async () => {
      const nickname = nicknameInput.value.trim();
      nicknameMsg.textContent = "";
      isNicknameValid = false;

      if (!nickname) {
        nicknameMsg.textContent = "닉네임을 입력하세요.";
        nicknameMsg.style.color = "red";
        return;
      }
      if (!/^[가-힣]+$/.test(nickname)) {
        nicknameMsg.textContent = "닉네임은 한글만 가능합니다.";
        nicknameMsg.style.color = "red";
        return;
      }

      try {
        const res = await fetch(`${BASE_API}/api/users/check-nickname?nickname=${encodeURIComponent(nickname)}`);
        const data = await res.json();
        if (data.exists) {
          nicknameMsg.textContent = "이미 사용 중인 닉네임입니다.";
          nicknameMsg.style.color = "red";
          isNicknameValid = false;
        } else {
          nicknameMsg.textContent = "사용 가능한 닉네임입니다.";
          nicknameMsg.style.color = "green";
          isNicknameValid = true;
        }
      } catch (e) {
        console.error(e);
        nicknameMsg.textContent = "서버 오류";
        nicknameMsg.style.color = "red";
      }
    });

    // ===== 회원가입 버튼 클릭 (인증 코드 발송) =====
    document.getElementById('signupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMsg.textContent = "";

      const email = emailInput.value.trim().toLowerCase();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (!isEmailValid) { errorMsg.textContent = "이메일 중복 확인을 해주세요."; return; }
      if (!isNicknameValid) { errorMsg.textContent = "닉네임 중복 확인을 해주세요."; return; }

      if (password !== confirmPassword) {
        errorMsg.textContent = "비밀번호가 일치하지 않습니다.";
        return;
      }

      const regex = /^(?=.*[A-Z])(?=.*[!@#$])(?=.*[0-9])[A-Za-z0-9!@#$]{1,10}$/;
      if (!regex.test(password)) {
        errorMsg.textContent = "비밀번호는 영문+숫자 10자 이내, 대문자 1개 이상, !,@,#,$ 중 하나를 포함해야 합니다.";
        return;
      }

      try {
        await fetch(`${BASE_API}/api/auth/email/send?email=${encodeURIComponent(email)}`, { method: 'POST' });
        alert("이메일로 인증 코드가 발송되었습니다!");
        document.getElementById('emailVerification').style.display = 'block';
      } catch (err) {
        console.error(err);
        errorMsg.textContent = "이메일 발송 실패";
      }
    });

    // ===== 인증 확인 버튼 (코드 검증 후 회원가입) =====
    document.getElementById("verifyBtn").addEventListener("click", async () => {
      const code = document.getElementById("verificationCode").value.trim();
      const email = emailInput.value.trim().toLowerCase();
      const password = document.getElementById("password").value;
      const nickname = nicknameInput.value.trim();

      try {
        const res = await fetch(`${BASE_API}/api/auth/email/verify?email=${encodeURIComponent(email)}&code=${encodeURIComponent(code)}`, { method:'POST' });
        const text = await res.text();
        const msg = document.getElementById("verifyMsg");
        msg.innerText = text;
        msg.style.color = res.ok ? "green" : "red";

        if (!res.ok) return;

        const signupRes = await fetch(`${BASE_API}/api/users/signup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, nickname })
        });

        if (signupRes.ok) {
          alert("회원가입 완료! 로그인 페이지로 이동합니다.");
          window.location.href = "login.html";
        } else {
          alert("회원가입 실패");
        }
      } catch (err) {
        console.error(err);
        errorMsg.textContent = "인증/가입 중 오류 발생";
      }
    });
</script>
</body>
</html>