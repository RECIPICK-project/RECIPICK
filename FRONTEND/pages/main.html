<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>RECIPICK Â· ë©”ì¸</title>

  <!-- ê¸°ì¡´ CSS -->
  <link rel="stylesheet" href="../css/tokens.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <link rel="stylesheet" href="../css/main.css" />

  <script src="../js/common_tabbar.js" defer></script>

</head>

<body>
  <main class="phone" role="main" aria-label="ë©”ì¸ í™”ë©´">

    <!-- í—¤ë” -->
    <header class="top">
       <div class="logo">
    	<img src="/image/logo-main.png" class="logo-img" alt="ë¡œê³ " />
       </div>
      <button class="notif" aria-label="ì•Œë¦¼">
        <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 17h5l-1.4-1.4A2 2 0 0 1 18 14.2V11a6 6 0 0 0-12 0v3.2c0 .5-.2 1-.6 1.4L4 17h5" />
          <path d="M10 21a2 2 0 0 0 4 0" />
        </svg>
      </button>
    </header>

    <!-- ê²€ìƒ‰ -->
    <section class="search">
      <form class="search-row" action="search_home.html" method="get">
        <input class="search-input" type="search" name="q" placeholder="ë ˆì‹œí”¼, ì¬ë£Œ, íƒœê·¸ ê²€ìƒ‰" autocomplete="off" />
        <button class="btn-go" type="submit">ê²€ìƒ‰</button>
      </form>
    </section>

    <!-- ì˜¤ëŠ˜ì˜ ì¶”ì²œ -->
        <section class="section" id="featuredSection">
      <div class="sec-head">
        <h2>ì˜¤ëŠ˜ì˜ ì¶”ì²œ</h2>
        <a class="more" href="search_home.html?sort=hot">ë”ë³´ê¸°</a>
      </div>

      <div class="hero" id="hero">
        <div class="slides" id="slides" aria-live="polite"></div>
        <div class="dots" role="tablist" aria-label="ì¶”ì²œ ìŠ¬ë¼ì´ë“œ"></div>
      </div>
    </section>

    <!-- ì¬ë£Œ -->
    <section class="category-section">
      <div class="sec-head">
        <h2>ì¬ë£Œ</h2>
      </div>
      <div class="category-grid" id="categoryGrid"></div>
    </section>

    <!-- ì¸ê¸° -->
    <section class="section">
      <div class="sec-head">
        <h2>ì¸ê¸° ë ˆì‹œí”¼</h2>
        <div class="sort">
          <button class="pill is-active">ì¸ê¸°</button>
          <button class="pill">ìµœì‹ </button>
          <button class="pill">ë³„ì </button>
        </div>
      </div>
      <div class="grid" id="grid"></div>

    </section>
  </main>
  <!-- ===== ìŠ¤í¬ë¦½íŠ¸ (ì¤‘ë³µ ì„ ì–¸ ì—†ìŒ) ===== -->
  <script>
    const BASE = '';
    const PAGES = BASE + '/pages';
    const PLACEHOLDER = 'https://placehold.co/1200x800?text=RECIPICK';

    /* URL ìœ í‹¸ */
    function toAbs(u) {
      if (!u) return null;
      if (/^https?:\/\//i.test(u)) return u;
      if (u.startsWith('/')) return BASE + u;
      return `${BASE}/uploads/${u}`;
    }
    function safeEncode(raw) { return encodeURIComponent(String(raw).trim()).replace(/%5C/gi, ''); }
    function proxyUrl(abs) { return abs ? `${BASE}/img-proxy?u=${safeEncode(abs)}` : null; }

    /* ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ */
    function testImage(url) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
        img.referrerPolicy = 'no-referrer';
        img.src = url;
      });
    }
    async function pickWorkingImage(raw) {
      const direct = toAbs(raw);
      const candidates = [direct, PLACEHOLDER].filter(Boolean);
      for (const u of candidates) if (await testImage(u)) return u;
      return PLACEHOLDER;
    }

    /* ì¬ë£Œ ì¹´í…Œê³ ë¦¬ ë Œë” */
    (function renderCategories() {
      const categories = [
        { name: 'ì†Œê³ ê¸°', icon: 'ğŸ¥©' }, { name: 'ë¼ì§€ê³ ê¸°', icon: 'ğŸ–' }, { name: 'ë‹­ê³ ê¸°', icon: 'ğŸ—' },
        { name: 'ë‹¬ê±€/ìœ ì œí’ˆ', icon: 'ğŸ¥š' }, { name: 'ê³¡ë¥˜', icon: 'ğŸŒ¾' },
        { name: 'ê³¼ì¼ë¥˜', icon: 'ğŸ' }, { name: 'ê°€ê³µì‹í’ˆë¥˜', icon: 'ğŸ¥«' }, { name: 'ê±´ì–´ë¬¼ë¥˜', icon: 'ğŸŸ' },
        { name: 'ë²„ì„¯ë¥˜', icon: 'ğŸ„' }, { name: 'ë°€ê°€ë£¨', icon: 'ğŸ§‚' }, { name: 'ê³¡ë¥˜', icon: 'ğŸš' },
        { name: 'ì±„ì†Œë¥˜', icon: 'ğŸ¥¦' }, { name: 'ì½©/ê²¬ê³¼ë¥˜', icon: 'ğŸ¥œ' }, { name: 'í•´ë¬¼ë¥˜', icon: 'ğŸ¦' },
      ];
      const grid = document.getElementById('categoryGrid');
      if (!grid) return;
      grid.innerHTML = categories.map(c => `
    <a class="category-item" href="${PAGES}/search_home.html?category=${encodeURIComponent(c.name)}" aria-label="${c.name}">
      <div class="cat-badge" aria-hidden="true">${c.icon}</div>
      <div class="category-name">${c.name}</div>
    </a>
  `).join('');
    })();

    /* ì •ë ¬ í† ê¸€ */
    document.querySelectorAll('.pill').forEach(p => {
      p.addEventListener('click', () => {
        document.querySelectorAll('.pill').forEach(x => x.classList.remove('is-active'));
        p.classList.add('is-active');
      });
    });

    /* ìºëŸ¬ì…€ ì œì–´ */
    let currentSlide = 0, totalSlides = 0, autoSlideInterval;
    function updateSlide() {
      const slides = document.getElementById('slides');
      const dots = document.querySelectorAll('.dot');
      slides.style.transform = `translateX(-${currentSlide * 100}%)`;
      dots.forEach((d, i) => d.classList.toggle('is-active', i === currentSlide));
    }
    function nextSlide() { if (totalSlides > 0) { currentSlide = (currentSlide + 1) % totalSlides; updateSlide(); } }
    function goToSlide(i) { currentSlide = i; updateSlide(); resetAutoSlide(); }
    function resetAutoSlide() { clearInterval(autoSlideInterval); if (totalSlides > 1) { autoSlideInterval = setInterval(nextSlide, 4000); } }

    /* ì˜¤ëŠ˜ì˜ ì¶”ì²œ */
        (async () => {
      try {
        const r = await fetch(`${BASE}/api/main/today`, { cache: 'no-store' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        let list = await r.json();
        if (!Array.isArray(list) || !list.length) {
          list = [{ id: 0, title: 'ì¶”ì²œ ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤', foodName: '', rcpImgUrl: null, likeCount: 0, viewCount: 0 }];
        }
        const slidesEl = document.getElementById('slides');
        slidesEl.innerHTML = list.map((it, i) => {
          const id = it.postId ?? it.id ?? it.post_id;
          const href = id ? `/post_detail/${id}` : 'javascript:void(0)';
          return `
        <article class="slide" data-i="${i}">
          <a href="${href}" class="hero-link">
            <div class="hero-thumb" data-i="${i}"></div>
            <div class="hero-meta">
              <div class="hero-title">${it.title}</div>
              <div class="hero-sub">â¤ï¸ ${it.likeCount} Â· ğŸ‘ï¸ ${it.viewCount}</div>
            </div>
          </a>
        </article>
      `;
        }).join('');

        await Promise.all(list.map(async (it, idx) => {
          const good = await pickWorkingImage(it.rcpImgUrl);
          const thumbEl = slidesEl.querySelector(`.hero-thumb[data-i="${idx}"]`);
          if (thumbEl) {
            thumbEl.style.backgroundImage = `url('${good}')`;
          }
        }));

        const dotsWrap = document.querySelector('.dots');
        dotsWrap.innerHTML = list.map((_, i) =>
          `<button class="dot ${i === 0 ? 'is-active' : ''}" data-i="${i}" aria-label="${i + 1}ë²ˆ"></button>`
        ).join('');
        document.querySelectorAll('.dot').forEach((d, i) => d.addEventListener('click', () => goToSlide(i)));
        totalSlides = list.length;
        currentSlide = 0;
        updateSlide();
        resetAutoSlide();
      } catch (err) {
        console.error('[featured] load failed:', err);
        const slides = document.getElementById('slides');
        slides.innerHTML = `
      <article class="slide">
        <a href="javascript:void(0)" class="hero-link">
          <div class="hero-thumb" style="background-image:url('${PLACEHOLDER}')"></div>
          <div class="hero-meta">
            <div class="hero-title">ì¶”ì²œì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”</div>
            <div class="hero-sub">ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” ë°ì´í„° ë¬¸ì œì¼ ìˆ˜ ìˆì–´ìš”</div>
          </div>
        </a>
      </article>`;
        document.querySelector('.dots').innerHTML = `<button class="dot is-active" data-i="0" aria-label="1ë²ˆ"></button>`;
        totalSlides = 1; currentSlide = 0; updateSlide();
      }
    })();

    /* ì¸ê¸° ë ˆì‹œí”¼ */
    (async () => {
      try {
        const r = await fetch(`${BASE}/api/main/popular-grid`, { cache: 'no-store' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const items = await r.json();
        const list = Array.isArray(items) && items.length ? items : [{
          id: 0, title: 'ìƒ˜í”Œ ë ˆì‹œí”¼', foodName: '', rcpImgUrl: null, likeCount: 0, viewCount: 0
        }];

        const grid = document.getElementById('grid');
        grid.innerHTML = list.map((it, i) => {
          const id = it.postId ?? it.id ?? it.post_id;
          const href = id ? `/post_detail/${id}` : 'javascript:void(0)';
          return `
        <a class="card" href="${href}" data-i="${i}">
          <div class="thumb"></div>
          <div class="meta">
            <div class="title">${it.title}</div>
            <div class="sub">â¤ï¸ ${it.likeCount} Â· ğŸ‘ï¸ ${it.viewCount}</div>
          </div>
        </a>`;
        }).join('');
        await Promise.all(list.map(async (it, idx) => {
          const good = await pickWorkingImage(it.rcpImgUrl);
          grid.querySelector(`.card[data-i="${idx}"] .thumb`).style.backgroundImage = `url('${good}')`;
        }));
      } catch (err) {
        console.error('[popular] load failed:', err);
      }
    })();
  </script>

  <script>
    /* â–¼ ì¶”ê°€: ìŠ¬ë¼ì´ë“œ ë©”ë‰´ í† ê¸€ ë°•ìŠ¤ë§Œ (ê¸°ì¡´ ì½”ë“œ ì†ëŒ€ì§€ ë§ê³  ë§¨ ì•„ë˜ ë¶™ì´ê¸°) */
    function openSlideMenu() {
      const sheet = document.getElementById('slideMenu');
      if (!sheet) return;
      sheet.style.visibility = 'visible';
      sheet.style.opacity = '1';
      requestAnimationFrame(() => {
        sheet.classList.add('active');
        document.body.style.overflow = 'hidden';
      });
    }
    function closeSlideMenu() {
      const sheet = document.getElementById('slideMenu');
      if (!sheet) return;
      sheet.classList.remove('active');
      document.body.style.overflow = '';
      setTimeout(() => {
        if (!sheet.classList.contains('active')) {
          sheet.style.opacity = '0';
          sheet.style.visibility = 'hidden';
        }
      }, 300);
    }
    function toggleSlideMenu() {
      const sheet = document.getElementById('slideMenu');
      if (!sheet) return;
      sheet.classList.contains('active') ? closeSlideMenu() : openSlideMenu();
    }

    document.addEventListener('DOMContentLoaded', () => {
      const sheet = document.getElementById('slideMenu');
      if (sheet) {
        const overlay = sheet.querySelector('.slide-menu-overlay');
        if (overlay) overlay.addEventListener('click', closeSlideMenu);
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSlideMenu(); });
      }
      /* íƒ­ë°”ì˜ 'ë©”ë‰´' aíƒœê·¸ í´ë¦­ì„ ê°€ë¡œì±„ì„œ ì‹œíŠ¸ë¥¼ ì—´ê¸° (ê¸°ì¡´ a ìœ ì§€) */
      const tabbar = document.querySelector('.tabbar');
      if (tabbar) {
        tabbar.addEventListener('click', (e) => {
          const tab = e.target.closest('.tab');
          if (!tab) return;
          const isMenu = (tab.getAttribute('aria-label') || '').includes('ë©”ë‰´');
          if (isMenu) {
            e.preventDefault(); // menu.html ì´ë™ ë§‰ê³ 
            toggleSlideMenu();  // ì‹œíŠ¸ ì—´ê¸°
          }
        });
      }
    });
  </script>
  <script>
    // ğŸ” ê²€ìƒ‰ ì…ë ¥ê°’ì„ ì¹´í…Œê³ ë¦¬ë¡œ ì¸ì‹í•˜ë©´ category íŒŒë¼ë¯¸í„°ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    (function enableCategorySmartSearch() {
      const form = document.querySelector('form.search-row');
      const input = document.querySelector('.search-input');
      if (!form || !input) return;

      // formì˜ submit ì´ë²¤íŠ¸ë¥¼ ê°€ë¡œì±„ì„œ í•­ìƒ ì œëª© ê²€ìƒ‰ìœ¼ë¡œ ë³´ëƒ…ë‹ˆë‹¤.
      form.addEventListener('submit', (e) => {
        e.preventDefault(); // ê¸°ë³¸ ë™ì‘(actionìœ¼ë¡œ ì´ë™)ì„ ë§‰ìŠµë‹ˆë‹¤.

        const raw = input.value || '';
        if (!raw.trim()) return; // ë¹ˆ ê²€ìƒ‰ì–´ëŠ” ë¬´ì‹œí•©ë‹ˆë‹¤.

        // ìƒë‹¨ ìŠ¤í¬ë¦½íŠ¸ì— ì •ì˜ëœ PAGES ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        const base = (typeof PAGES !== 'undefined' ? PAGES : '');
        // ì–´ë–¤ ê²€ìƒ‰ì–´ë“  searchType=title ê³¼ q íŒŒë¼ë¯¸í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ê²€ìƒ‰ í˜ì´ì§€ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤.
        location.href = `${base}/search_home.html?searchType=title&q=${encodeURIComponent(raw)}`;
      });
    })();
  </script>



</body>

</html>
