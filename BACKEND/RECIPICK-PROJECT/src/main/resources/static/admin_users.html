<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Β· μ‚¬μ©μ κ΄€λ¦¬</title>
  <link rel="stylesheet" href="css/tokens.css" />
  <link rel="stylesheet" href="css/components.css" />
  <link rel="stylesheet" href="css/admin.css" />
  <link rel="stylesheet" href="css/admin_users.css" />
  <script defer src="js/theme.js"></script>
</head>
<body class="admin">
<div class="admin-layout">
  <!-- μ‚¬μ΄λ“λ°” -->
  <aside class="side">
    <div class="logo">LOGO</div>
    <nav class="sidemenu">
      <a class="m" href="admin.html">λ€μ‹λ³΄λ“</a>
      <a class="m" href="admin_reports.html">μ‹ κ³  κ΄€λ¦¬</a>
      <a class="m" href="admin_recipes.html">λ μ‹ν”Ό/λ“κΈ€ κ΄€λ¦¬</a>
      <a class="m active" href="admin_users.html">μ μ € κ΄€λ¦¬</a>
      <a class="m" href="admin_settings.html">μ„Έν…</a>
    </nav>
  </aside>

  <!-- λ³΄λ“ -->
  <main class="board">
    <div class="topbar">
      <h1>μ‚¬μ©μ κ΄€λ¦¬</h1>
      <div class="actions">
        <input class="input" type="search" id="search" placeholder="μ΄λ©”μΌ/λ‹‰λ„¤μ„ κ²€μƒ‰" />
        <button class="btn" id="searchBtn">κ²€μƒ‰</button>
      </div>
    </div>

    <!-- π“ κ°•μ΅°: μ‹ κ³  λ§μ€ μ μ € ν•„ν„° -->
    <section class="card" aria-labelledby="riskTitle">
      <h2 class="card-title" id="riskTitle">λ¦¬μ¤ν¬ ν•„ν„°</h2>
      <div class="pills">
        <button class="pill is-active" data-filter="all">μ „μ²΄</button>
        <button class="pill" data-filter="reported">μ‹ κ³  λ‹¤μ(β‰¥3)</button>
        <button class="pill" data-filter="lowPoint">ν¬μΈνΈ μ €μ (β‰¤0)</button>
      </div>
      <p class="desc">μ‹ κ³  λ„μ Β·ν¬μΈνΈ μƒνƒλ΅ λΉ λ¥΄κ² μ„ λ³„ν•μ„Έμ”. μ‹ κ³  μ„κ³„κ°’μ€ μ •μ±…μ—μ„ μ΅°μ • κ°€λ¥ν•©λ‹λ‹¤.</p>
    </section>

    <!-- π“ μ μ € λ¦¬μ¤νΈ -->
    <section class="card" aria-labelledby="listTitle">
      <h2 class="card-title" id="listTitle">μ‚¬μ©μ λ©λ΅</h2>
      <div class="user-list">
        <ul id="userList">
          <!-- μμ‹ μ•„μ΄ν… (μ‹¤μ μ—μ„  λ°±μ—μ„ μ£Όλ” λ°μ΄ν„°λ΅ λ λ”) -->
          <li class="user-item" data-uid="u_1021" data-reports="4" data-points="-12" data-tier="Bronze">
            <div class="user-main">
              <div class="user-title">ν™κΈΈλ™ Β· user@mail.com</div>
              <div class="user-meta">
                <span>UID: u_1021</span>
                <span>κ°€μ…μΌ: 2025-07-12</span>
                <span>ν¬μΈνΈ: <strong class="u-point">-12</strong></span>
                <span>μ‹ κ³  λ„μ : <strong class="u-report">4</strong>κ±΄</span>
              </div>
            </div>
            <div class="user-right">
              <span class="badge tier js-tier">Bronze</span>
              <span class="badge warn js-flag" title="μ‹ κ³  λ‹¤μ">μ‹ κ³ μ£Όμ</span>
              <button class="btn-ghost small js-view">λ³΄κΈ°</button>
              <button class="btn-ghost small js-edit" data-open="userModal">μμ •</button>
            </div>
          </li>

          <li class="user-item" data-uid="u_1500" data-reports="0" data-points="680" data-tier="Gold">
            <div class="user-main">
              <div class="user-title">κΉ€λ μ‹ Β· kim@cook.com</div>
              <div class="user-meta">
                <span>UID: u_1500</span>
                <span>κ°€μ…μΌ: 2025-03-02</span>
                <span>ν¬μΈνΈ: <strong class="u-point">680</strong></span>
                <span>μ‹ κ³  λ„μ : <strong class="u-report">0</strong>κ±΄</span>
              </div>
            </div>
            <div class="user-right">
              <span class="badge tier js-tier">Gold</span>
              <span class="badge ok">μ°μ</span>
              <button class="btn-ghost small js-view">λ³΄κΈ°</button>
              <button class="btn-ghost small js-edit" data-open="userModal">μμ •</button>
            </div>
          </li>

          <li class="user-item" data-uid="u_990" data-reports="2" data-points="120" data-tier="Silver">
            <div class="user-main">
              <div class="user-title">λ°•λ“κΈ€ Β· reply@site.com</div>
              <div class="user-meta">
                <span>UID: u_990</span>
                <span>κ°€μ…μΌ: 2025-06-01</span>
                <span>ν¬μΈνΈ: <strong class="u-point">120</strong></span>
                <span>μ‹ κ³  λ„μ : <strong class="u-report">2</strong>κ±΄</span>
              </div>
            </div>
            <div class="user-right">
              <span class="badge tier js-tier">Silver</span>
              <button class="btn-ghost small js-view">λ³΄κΈ°</button>
              <button class="btn-ghost small js-edit" data-open="userModal">μμ •</button>
            </div>
          </li>
        </ul>
      </div>
    </section>

    <!-- π“ λ“±κΈ‰/ν† ν°/ν¬μΈνΈ μ •μ±… (λ΅μ»¬ μ €μ¥) -->
    <section class="card" aria-labelledby="policyTitle">
      <h2 class="card-title" id="policyTitle">λ“±κΈ‰/ν† ν°/ν¬μΈνΈ μ •μ±…</h2>
      <p class="desc">λ“±κΈ‰λ³„ AI ν† ν° ν•λ„μ™€ ν¬μΈνΈ κ·μΉ™μ„ μ„¤μ •ν•©λ‹λ‹¤. μ €μ¥ μ‹ λ΅μ»¬μ— λ³΄κ΄€λ©λ‹λ‹¤.</p>
      <div class="form-grid">
        <div class="row">
          <label>Bronze ν† ν°/μΌ</label>
          <input class="input" id="tokBronze" type="number" min="0" step="10" value="200" style="max-width:140px"/>
        </div>
        <div class="row">
          <label>Silver ν† ν°/μΌ</label>
          <input class="input" id="tokSilver" type="number" min="0" step="10" value="500" style="max-width:140px"/>
        </div>
        <div class="row">
          <label>Gold ν† ν°/μΌ</label>
          <input class="input" id="tokGold" type="number" min="0" step="10" value="1000" style="max-width:140px"/>
        </div>

        <div class="row">
          <label>λ“κΈ€ 1κ°</label>
          <input class="input" id="ptComment" type="number" min="0" step="1" value="1" style="max-width:140px"/>
        </div>
        <div class="row">
          <label>λ μ‹ν”Ό λ“±λ΅</label>
          <input class="input" id="ptRecipe" type="number" min="0" step="1" value="10" style="max-width:140px"/>
        </div>
        <div class="row">
          <label>μΉκ²© λ³΄λ„μ¤</label>
          <input class="input" id="ptPromote" type="number" min="0" step="1" value="100" style="max-width:140px"/>
        </div>

        <div class="row">
          <label>μ‹ κ³  μ„κ³„(μ£Όμ)</label>
          <input class="input" id="reportThreshold" type="number" min="1" step="1" value="3" style="max-width:140px"/>
        </div>

        <div class="row" style="grid-column:1/-1">
          <div class="actions">
            <button class="btn" id="savePolicy">μ €μ¥</button>
            <button class="btn-ghost" id="resetPolicy">μ΄κΈ°ν™”</button>
            <span class="badge ok" id="policySaved" style="display:none">μ €μ¥λ¨</span>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- μ‚¬μ©μ μμ • λ¨λ‹¬ -->
<div class="modal" id="userModal" aria-hidden="true">
  <div class="overlay" data-close></div>
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="userTitle">
    <div class="dialog-head">
      <h3 id="userTitle">μ‚¬μ©μ μ •λ³΄</h3>
      <button class="close" data-close aria-label="λ‹«κΈ°">Γ—</button>
    </div>
    <div class="dialog-body">
      <div class="row"><strong style="min-width:88px; color:var(--muted)">UID</strong> <span id="mUid">-</span></div>
      <div class="row"><strong style="min-width:88px; color:var(--muted)">λ‹‰λ„¤μ„</strong> <span id="mName">-</span></div>
      <div class="row"><strong style="min-width:88px; color:var(--muted)">μ΄λ©”μΌ</strong> <span id="mMail">-</span></div>

      <label class="row">
        <span style="min-width:88px; color:var(--muted)">λ“±κΈ‰</span>
        <select class="input" id="mTier" style="max-width:160px">
          <option>Bronze</option>
          <option>Silver</option>
          <option>Gold</option>
        </select>
      </label>

      <label class="row">
        <span style="min-width:88px; color:var(--muted)">ν¬μΈνΈ</span>
        <input class="input" id="mPoint" type="number" step="1" style="max-width:140px" />
      </label>

      <div class="row col" style="gap:6px">
        <strong style="min-width:88px; color:var(--muted)">μ‹ κ³ </strong>
        <div id="mReports" class="soft" style="background:#F9FBE7; border:1px solid var(--line); border-radius:8px; padding:10px">
          μµκ·Ό 30μΌ: 0κ±΄
        </div>
      </div>
    </div>
    <div class="dialog-foot">
      <button class="btn-ghost" data-close>μ·¨μ†</button>
      <button class="btn success" id="saveUser">μ €μ¥</button>
    </div>
  </div>
</div>

<script>
  (() => {
    // ===== λ΅μ»¬ ν‚¤
    const KEY_POLICY = 'userPolicy';

    // ===== ν—¬νΌ
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
    const getPolicy = () => {
      try{ return JSON.parse(localStorage.getItem(KEY_POLICY)) }catch(e){ return null }
    };
    const setPolicy = (p) => localStorage.setItem(KEY_POLICY, JSON.stringify(p));

    // ===== μ •μ±… μ΄κΈ° λ λ”
    const defaultPolicy = {
      tokens: { Bronze:200, Silver:500, Gold:1000 },
      points: { comment:1, recipe:10, promote:100 },
      reportThreshold: 3
    };
    function renderPolicyForm(p){
      $('#tokBronze').value = p.tokens.Bronze;
      $('#tokSilver').value = p.tokens.Silver;
      $('#tokGold').value = p.tokens.Gold;
      $('#ptComment').value = p.points.comment;
      $('#ptRecipe').value = p.points.recipe;
      $('#ptPromote').value = p.points.promote;
      $('#reportThreshold').value = p.reportThreshold;
    }
    const policy = getPolicy() || defaultPolicy;
    renderPolicyForm(policy);

    // ===== μ •μ±… μ €μ¥/μ΄κΈ°ν™”
    $('#savePolicy').addEventListener('click', ()=>{
      const p = {
        tokens:{
          Bronze:+$('#tokBronze').value,
          Silver:+$('#tokSilver').value,
          Gold:+$('#tokGold').value
        },
        points:{
          comment:+$('#ptComment').value,
          recipe:+$('#ptRecipe').value,
          promote:+$('#ptPromote').value
        },
        reportThreshold:+$('#reportThreshold').value
      };
      setPolicy(p);
      $('#policySaved').style.display='inline-block';
      setTimeout(()=> $('#policySaved').style.display='none', 1500);
      applyFlags(); // μ‹ κ³ μ£Όμ λ°°μ§€ κ°±μ‹ 
    });
    $('#resetPolicy').addEventListener('click', ()=>{
      setPolicy(defaultPolicy);
      renderPolicyForm(defaultPolicy);
      applyFlags();
    });

    // ===== λ¦¬μ¤νΈ ν•„ν„°/κ²€μƒ‰
    function matchesFilter(li, active){
      const pts = +$('.u-point', li).textContent;
      const reps = +$('.u-report', li).textContent;
      if(active==='reported') return reps >= (getPolicy()?.reportThreshold ?? 3);
      if(active==='lowPoint') return pts <= 0;
      return true;
    }
    function filterList(){
      const active = $('.pill.is-active')?.dataset.filter || 'all';
      const q = $('#search').value.trim().toLowerCase();
      $$('#userList .user-item').forEach(li=>{
        const text = li.innerText.toLowerCase();
        const ok = matchesFilter(li, active) && (!q || text.includes(q));
        li.style.display = ok ? '' : 'none';
      });
    }
    $$('.pill').forEach(p=>{
      p.addEventListener('click', ()=>{
        $$('.pill').forEach(x=>x.classList.remove('is-active'));
        p.classList.add('is-active');
        filterList();
      });
    });
    $('#searchBtn').addEventListener('click', filterList);

    // ===== μ‹ κ³ μ£Όμ/μ°μ λ°°μ§€ ν‘μ‹
    function applyFlags(){
      const thresh = getPolicy()?.reportThreshold ?? 3;
      $$('#userList .user-item').forEach(li=>{
        const reps = +li.dataset.reports;
        const flag = $('.js-flag', li);
        if(reps >= thresh){
          if(!flag){
            const span = document.createElement('span');
            span.className = 'badge warn js-flag';
            span.textContent = 'μ‹ κ³ μ£Όμ';
            $('.user-right', li).insertBefore(span, $('.js-view', li));
          }else{
            flag.className = 'badge warn js-flag';
            flag.textContent = 'μ‹ κ³ μ£Όμ';
          }
        }else{
          if(flag) flag.remove();
          // μ°μ λ°°μ§€λ” ν¬μΈνΈ λ“± κΈ°μ¤€μΌλ΅ μ»¤μ¤ν…€ κ°€λ¥(μƒν”μ€ Goldμ—λ§ ν‘μ‹)
          if($('.js-tier', li)?.textContent === 'Gold'){
            if(!$('.badge.ok', li)){
              const ok = document.createElement('span');
              ok.className = 'badge ok';
              ok.textContent = 'μ°μ';
              $('.user-right', li).insertBefore(ok, $('.js-view', li));
            }
          }
        }
      });
    }
    applyFlags();

    // ===== μ‚¬μ©μ λ¨λ‹¬
    let currentLi = null;
    $$('#userList .js-edit').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        currentLi = e.target.closest('.user-item');
        const uid = currentLi.dataset.uid;
        const name = $('.user-title', currentLi).textContent.split(' Β· ')[0];
        const mail = $('.user-title', currentLi).textContent.split(' Β· ')[1] || '-';
        const tier = $('.js-tier', currentLi).textContent;
        const pts = +$('.u-point', currentLi).textContent;
        const reps = +$('.u-report', currentLi).textContent;

        $('#mUid').textContent = uid;
        $('#mName').textContent = name;
        $('#mMail').textContent = mail;
        $('#mTier').value = tier;
        $('#mPoint').value = pts;
        $('#mReports').textContent = `μµκ·Ό 30μΌ: ${reps}κ±΄`;

        $('#userModal').setAttribute('aria-hidden','false');
        document.documentElement.style.overflow = 'hidden';
      });
    });
    // μ—΄κΈ°
    function openUserModal(){
      document.getElementById('userModal').setAttribute('aria-hidden','false');
      // μ¤ν¬λ΅¤ λ½
      document.documentElement.style.overflow = 'hidden';
    }
    // λ‹«κΈ°
    function closeUserModal(){
      document.getElementById('userModal').setAttribute('aria-hidden','true');
      document.documentElement.style.overflow = '';
    }

    // νΈλ¦¬κ±° μ—°κ²° (κΈ°μ΅΄ μ΄λ²¤νΈμ—μ„ open/closeλ§ λ°”κΏ” μ£Όλ©΄ λ¨)
    document.querySelectorAll('#userModal [data-close]').forEach(btn=>{
      btn.addEventListener('click', closeUserModal);
    });
    // μ: μμ • λ²„νΌ ν΄λ¦­ μ‹
    document.querySelectorAll('#userList .js-edit').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        // ...λ°μ΄ν„° λ°”μΈλ”©...
        openUserModal();
      });
    });

    // λ³΄κΈ°(λ”λ―Έ)
    $$('#userList .js-view').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const li = e.target.closest('.user-item');
        alert(`μ‚¬μ©μ μƒμ„Έ(λ”λ―Έ): ${li.dataset.uid}`);
      });
    });

    // λ‹«κΈ°
    $$('#userModal [data-close]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $('#userModal').setAttribute('aria-hidden','true');
        document.documentElement.style.overflow = '';
      });
    });

    // μ €μ¥ β†’ UI λ°μ
    $('#saveUser').addEventListener('click', ()=>{
      if(!currentLi) return;
      const newTier = $('#mTier').value;
      const newPts = +$('#mPoint').value;

      $('.js-tier', currentLi).textContent = newTier;
      $('.u-point', currentLi).textContent = newPts;

      // μ°μ/μ‹ κ³ μ£Όμ λ±ƒμ§€ κ°±μ‹ 
      applyFlags();

      $('#userModal').setAttribute('aria-hidden','true');
      document.documentElement.style.overflow = '';
    });

    // μ΄κΈ° ν•„ν„° μ μ©
    filterList();
  })();
</script>
</body>
</html>
