<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>RECIPICK · 메인</title>

  <!-- 기존 CSS -->
  <link rel="stylesheet" href="../css/tokens.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <link rel="stylesheet" href="../css/main.css" />

</head>

<body>
  <main class="phone" role="main" aria-label="메인 화면">

    <!-- 헤더 -->
    <header class="top">
      <h1 class="logo">RECIPICK</h1>
      <button class="notif" aria-label="알림">
        <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 17h5l-1.4-1.4A2 2 0 0 1 18 14.2V11a6 6 0 0 0-12 0v3.2c0 .5-.2 1-.6 1.4L4 17h5" />
          <path d="M10 21a2 2 0 0 0 4 0" />
        </svg>
      </button>
    </header>

    <!-- 검색 -->
    <section class="search">
      <form class="search-row" action="search.html" method="get">
        <svg class="icon" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#6b7280" stroke-width="2">
          <circle cx="11" cy="11" r="7"></circle>
          <path d="M20 20l-3.5-3.5"></path>
        </svg>
        <input class="search-input" type="search" name="q" placeholder="레시피, 재료, 태그 검색" autocomplete="off" />
        <button class="filter" type="button" onclick="location.href='filter.html'">필터</button>
      </form>
    </section>

    <!-- 오늘의 추천 -->
    <section class="section" id="featuredSection">
      <div class="sec-head">
        <h2>오늘의 추천</h2>
        <a class="more" href="search.html?sort=hot">더보기</a>
      </div>

      <div class="hero is-17x" id="hero">
        <div class="slides" id="slides" aria-live="polite"></div>
        <div class="dots" role="tablist" aria-label="추천 슬라이드"></div>
      </div>
    </section>

    <!-- 재료 -->
    <section class="category-section">
      <div class="sec-head">
        <h2>재료</h2>
      </div>
      <div class="category-grid" id="categoryGrid"></div>
    </section>

    <!-- 인기 -->
    <section class="section">
      <div class="sec-head">
        <h2>인기 레시피</h2>
        <div class="sort">
          <button class="pill is-active">인기</button>
          <button class="pill">최신</button>
          <button class="pill">별점</button>
        </div>
      </div>
      <div class="grid" id="grid"></div>
    </section>

    <nav class="tabbar" aria-label="하단 탭바">
      <!-- 메뉴: 시트 열기 -->
      <button class="tab" type="button" aria-label="메뉴" onclick="toggleSlideMenu()">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#6b7280" stroke-width="2">
          <path d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>

      <!-- 좋아요 -->
      <a class="tab is-active" href="liked.html" aria-label="좋아요">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="#2E7D32">
          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5
               2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09
               C13.09 3.81 14.76 3 16.5 3
               19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55
               11.54L12 21.35z" />
        </svg>
      </a>

      <!-- 검색 -->
      <a class="tab" href="search.html" aria-label="검색">
        <div class="ring">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="#6b7280" stroke-width="2">
            <circle cx="11" cy="11" r="7" />
            <path d="M20 20l-3.5-3.5" />
          </svg>
        </div>
      </a>

      <!-- 추가 -->
      <a class="tab" href="post_upload.html" aria-label="추가">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#6b7280" stroke-width="2">
          <path d="M12 5v14M5 12h14" />
        </svg>
      </a>

      <!-- 프로필 -->
      <a class="tab" href="profile.html" aria-label="프로필">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#6b7280" stroke-width="2">
          <circle cx="12" cy="8" r="4" />
          <path d="M4 20c2-4 14-4 16 0" />
        </svg>
      </a>
    </nav>


  </main>
  <!-- ▼ 추가: 슬라이드 업 메뉴 -->
  <div class="slide-menu" id="slideMenu">
    <div class="slide-menu-overlay"></div>
    <div class="slide-menu-content">
      <div class="slide-menu-header">
        <h2>메뉴</h2>
        <button class="close-menu-btn" onclick="closeSlideMenu()">
          <svg viewBox="0 0 24 24" width="20" height="20">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" fill="none" />
          </svg>
        </button>
      </div>
      <div class="slide-menu-items">
        <div class="menu-item" onclick="location.href='profile.html'">
          <svg class="menu-icon" viewBox="0 0 24 24">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
            <circle cx="12" cy="7" r="4" />
          </svg>
          <span>마이페이지</span>
        </div>
        <div class="menu-item" onclick="location.href='recipes.html'">
          <svg class="menu-icon" viewBox="0 0 24 24">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <polyline points="14,2 14,8 20,8" />
          </svg>
          <span>정식 레시피 조회</span>
        </div>
        <div class="menu-item" onclick="location.href='liked.html'">
          <svg class="menu-icon" viewBox="0 0 24 24">
            <path
              d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
          </svg>
          <span>좋아요한 레시피 조회</span>
        </div>
        <div class="menu-item" onclick="location.href='settings.html'">
          <svg class="menu-icon" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="3" />
            <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1m11 7.5a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" />
          </svg>
          <span>설정</span>
        </div>
        <div class="menu-item logout" onclick="/* TODO: logout() 연결 */">
          <svg class="menu-icon" viewBox="0 0 24 24">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
            <polyline points="16,17 21,12 16,7" />
            <line x1="21" y1="12" x2="9" y2="12" />
          </svg>
          <span>로그아웃</span>
        </div>
      </div>
    </div>
  </div>


  <!-- ===== 스크립트 (중복 선언 없음) ===== -->
  <script>
    const BASE = 'http://localhost:8080';
    const PAGES = BASE + '/pages';
    const PLACEHOLDER = 'https://placehold.co/1200x800?text=RECIPICK';

    /* URL 유틸 */
    function toAbs(u) {
      if (!u) return null;
      if (/^https?:\/\//i.test(u)) return u;
      if (u.startsWith('/')) return BASE + u;
      return `${BASE}/uploads/${u}`;
    }
    function safeEncode(raw) { return encodeURIComponent(String(raw).trim()).replace(/%5C/gi, ''); }
    function proxyUrl(abs) { return abs ? `${BASE}/img-proxy?u=${safeEncode(abs)}` : null; }

    /* 이미지 프리로드 */
    function testImage(url) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
        img.referrerPolicy = 'no-referrer';
        img.src = url;
      });
    }
    async function pickWorkingImage(raw) {
      const direct = toAbs(raw);
      const candidates = [proxyUrl(direct), direct, PLACEHOLDER].filter(Boolean);
      for (const u of candidates) if (await testImage(u)) return u;
      return PLACEHOLDER;
    }

    /* 재료 카테고리 렌더 */
    (function renderCategories() {
      const categories = [
        { name: '소고기', icon: '🥩' }, { name: '돼지고기', icon: '🍖' }, { name: '닭고기', icon: '🍗' },
        { name: '달걀/유제품류', icon: '🥚' }, { name: '곡류', icon: '🌾' },
        { name: '과일류', icon: '🍎' }, { name: '가공식품류', icon: '🥫' }, { name: '건어물류', icon: '🐟' },
        { name: '버섯류', icon: '🍄' }, { name: '밀가루', icon: '🧂' }, { name: '곡류', icon: '🍚' },
        { name: '채소류', icon: '🥦' }, { name: '콩/견과류', icon: '🥜' }, { name: '해물류', icon: '🦐' },
      ];
      const grid = document.getElementById('categoryGrid');
      if (!grid) return;
      grid.innerHTML = categories.map(c => `
    <a class="category-item" href="${PAGES}/search_home.html?category=${encodeURIComponent(c.name)}" aria-label="${c.name}">
      <div class="cat-badge" aria-hidden="true">${c.icon}</div>
      <div class="category-name">${c.name}</div>
    </a>
  `).join('');
    })();

    /* 정렬 토글 */
    document.querySelectorAll('.pill').forEach(p => {
      p.addEventListener('click', () => {
        document.querySelectorAll('.pill').forEach(x => x.classList.remove('is-active'));
        p.classList.add('is-active');
      });
    });

    /* 캐러셀 제어 */
    let currentSlide = 0, totalSlides = 0, autoSlideInterval;
    function updateSlide() {
      const slides = document.getElementById('slides');
      const dots = document.querySelectorAll('.dot');
      slides.style.transform = `translateX(-${currentSlide * 100}%)`;
      dots.forEach((d, i) => d.classList.toggle('is-active', i === currentSlide));
    }
    function nextSlide() { if (totalSlides > 0) { currentSlide = (currentSlide + 1) % totalSlides; updateSlide(); } }
    function goToSlide(i) { currentSlide = i; updateSlide(); resetAutoSlide(); }
    function resetAutoSlide() { clearInterval(autoSlideInterval); if (totalSlides > 1) { autoSlideInterval = setInterval(nextSlide, 4000); } }

    /* 오늘의 추천 */
    (async () => {
      try {
        const r = await fetch(`${BASE}/api/main/today`, { cache: 'no-store' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        let list = await r.json();
        if (!Array.isArray(list) || !list.length) {
          list = [{ id: 0, title: '추천 레시피가 없습니다', foodName: '', rcpImgUrl: null, likeCount: 0, viewCount: 0 }];
        }
        const slidesEl = document.getElementById('slides');
        slidesEl.innerHTML = list.map((it, i) => {
          const id = it.id ?? it.post_id ?? it.postId ?? '';
          const href = `${PAGES}/post_detail.html${id ? `?id=${id}` : ''}`;
          return `
        <article class="slide" data-i="${i}">
        <a href="${href}" class="hero-link">
        <div class="hero-thumb"></div>
        <div class="hero-meta">
          <div class="hero-title">${it.title}</div>
          <div class="hero-sub">❤️ ${it.likeCount} · 👁️ ${it.viewCount}</div>
        </div>
      </a>
      </article>
      `;
        }).join('');

        await Promise.all(list.map(async (it, idx) => {
          const good = await pickWorkingImage(it.rcpImgUrl);
          slidesEl.querySelector(`.slide[data-i="${idx}"] .hero-thumb`).style.backgroundImage = `url('${good}')`;
        }));

        const dotsWrap = document.querySelector('.dots');
        dotsWrap.innerHTML = list.map((_, i) =>
          `<button class="dot ${i === 0 ? 'is-active' : ''}" data-i="${i}" aria-label="${i + 1}번"></button>`
        ).join('');
        document.querySelectorAll('.dot').forEach((d, i) => d.addEventListener('click', () => goToSlide(i)));
        totalSlides = list.length;
        currentSlide = 0;
        updateSlide();
        resetAutoSlide();
      } catch (err) {
        console.error('[featured] load failed:', err);
        const slides = document.getElementById('slides');
        slides.innerHTML = `
      <article class="slide">
        <div class="hero-thumb" style="background-image:url('${PLACEHOLDER}')"></div>
        <div class="hero-meta">
          <div class="hero-title">추천을 불러오지 못했어요</div>
          <div class="hero-sub">네트워크 또는 데이터 문제일 수 있어요</div>
        </div>
      </article>`;
        document.querySelector('.dots').innerHTML = `<button class="dot is-active" data-i="0" aria-label="1번"></button>`;
        totalSlides = 1; currentSlide = 0; updateSlide();
      }
    })();

    /* 인기 레시피 */
    (async () => {
      try {
        const r = await fetch(`${BASE}/api/main/popular-grid`, { cache: 'no-store' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const items = await r.json();
        const list = Array.isArray(items) && items.length ? items : [{
          id: 0, title: '샘플 레시피', foodName: '', rcpImgUrl: null, likeCount: 0, viewCount: 0
        }];

        const grid = document.getElementById('grid');
        grid.innerHTML = list.map((it, i) => {
          const id = it.id ?? it.post_id ?? it.postId ?? '';
          const href = `${PAGES}/post_detail.html${id ? `?id=${id}` : ''}`;
          return `
        <a class="card" href="${href}" data-i="${i}">
          <div class="thumb"></div>
          <div class="meta">
            <div class="title">${it.title}</div>
            <div class="sub">❤️ ${it.likeCount} · 👁️ ${it.viewCount}</div>
          </div>
        </a>`;
        }).join('');
        await Promise.all(list.map(async (it, idx) => {
          const good = await pickWorkingImage(it.rcpImgUrl);
          grid.querySelector(`.card[data-i="${idx}"] .thumb`).style.backgroundImage = `url('${good}')`;
        }));
      } catch (err) {
        console.error('[popular] load failed:', err);
      }
    })();
  </script>

  <script>
    /* ▼ 추가: 슬라이드 메뉴 토글 박스만 (기존 코드 손대지 말고 맨 아래 붙이기) */
    function openSlideMenu() {
      const sheet = document.getElementById('slideMenu');
      if (!sheet) return;
      sheet.style.visibility = 'visible';
      sheet.style.opacity = '1';
      requestAnimationFrame(() => {
        sheet.classList.add('active');
        document.body.style.overflow = 'hidden';
      });
    }
    function closeSlideMenu() {
      const sheet = document.getElementById('slideMenu');
      if (!sheet) return;
      sheet.classList.remove('active');
      document.body.style.overflow = '';
      setTimeout(() => {
        if (!sheet.classList.contains('active')) {
          sheet.style.opacity = '0';
          sheet.style.visibility = 'hidden';
        }
      }, 300);
    }
    function toggleSlideMenu() {
      const sheet = document.getElementById('slideMenu');
      if (!sheet) return;
      sheet.classList.contains('active') ? closeSlideMenu() : openSlideMenu();
    }

    document.addEventListener('DOMContentLoaded', () => {
      const sheet = document.getElementById('slideMenu');
      if (sheet) {
        const overlay = sheet.querySelector('.slide-menu-overlay');
        if (overlay) overlay.addEventListener('click', closeSlideMenu);
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSlideMenu(); });
      }
      /* 탭바의 '메뉴' a태그 클릭을 가로채서 시트를 열기 (기존 a 유지) */
      const tabbar = document.querySelector('.tabbar');
      if (tabbar) {
        tabbar.addEventListener('click', (e) => {
          const tab = e.target.closest('.tab');
          if (!tab) return;
          const isMenu = (tab.getAttribute('aria-label') || '').includes('메뉴');
          if (isMenu) {
            e.preventDefault(); // menu.html 이동 막고
            toggleSlideMenu();  // 시트 열기
          }
        });
      }
    });
  </script>


</body>

</html>
