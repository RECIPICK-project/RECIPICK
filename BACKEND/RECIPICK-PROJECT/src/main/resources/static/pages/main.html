<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>RECIPICK Â· ë©”ì¸</title>

  <!-- ê¸°ì¡´ CSS -->
  <link rel="stylesheet" href="../css/tokens.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <link rel="stylesheet" href="../css/main.css" />

  <!-- ë©”ì¸ ì „ìš© ì˜¤ë²„ë¼ì´ë“œ: ì˜¤ëŠ˜ì˜ ì¶”ì²œ(íˆì–´ë¡œ) ì„¸ë¡œ 1.7ë°° & ê¸°ë³¸ ìŠ¬ë¼ì´ë” ë ˆì´ì•„ì›ƒ -->
  <style>
    .hero.is-17x { height:auto !important; }
    .hero.is-17x .hero-thumb{
      height: 374px;                 /* 220px Ã— 1.7 */
      background-size: cover;
      background-position: center;
      border-radius: 18px;
    }
    .hero .slides{ display:flex; transition:transform .45s ease; will-change:transform; }
    .hero .slide{ min-width:100%; display:grid; grid-template-rows: 1fr auto; gap:10px; }
    .hero .hero-meta{ padding:0 2px; } /* í…ìŠ¤íŠ¸ëŠ” ì´ë¯¸ì§€ ì•„ë˜ì— ê¹”ë”í•˜ê²Œ */
  </style>
</head>
<body>
<main class="phone" role="main" aria-label="ë©”ì¸ í™”ë©´">

  <!-- í—¤ë” -->
  <header class="top">
    <h1 class="logo">RECIPICK</h1>
    <button class="notif" aria-label="ì•Œë¦¼">
      <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M15 17h5l-1.4-1.4A2 2 0 0 1 18 14.2V11a6 6 0 0 0-12 0v3.2c0 .5-.2 1-.6 1.4L4 17h5" />
        <path d="M10 21a2 2 0 0 0 4 0" />
      </svg>
    </button>
  </header>

  <!-- ê²€ìƒ‰ -->
  <section class="search">
    <form class="search-row" action="search.html" method="get">
      <svg class="icon" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#6b7280" stroke-width="2">
        <circle cx="11" cy="11" r="7"></circle><path d="M20 20l-3.5-3.5"></path>
      </svg>
      <input class="search-input" type="search" name="q" placeholder="ë ˆì‹œí”¼, ì¬ë£Œ, íƒœê·¸ ê²€ìƒ‰" autocomplete="off" />
      <button class="filter" type="button" onclick="location.href='filter.html'">í•„í„°</button>
    </form>
  </section>

  <!-- ì˜¤ëŠ˜ì˜ ì¶”ì²œ -->
  <section class="section" id="featuredSection">
    <div class="sec-head">
      <h2>ì˜¤ëŠ˜ì˜ ì¶”ì²œ</h2>
      <a class="more" href="search.html?sort=hot">ë”ë³´ê¸°</a>
    </div>

    <div class="hero is-17x" id="hero">
      <div class="slides" id="slides" aria-live="polite"></div>
      <div class="dots" role="tablist" aria-label="ì¶”ì²œ ìŠ¬ë¼ì´ë“œ"></div>
    </div>
  </section>

  <!-- ì¬ë£Œ -->
  <section class="category-section">
    <div class="sec-head"><h2>ì¬ë£Œ</h2></div>
    <div class="category-grid" id="categoryGrid"></div>
  </section>

  <!-- ì¸ê¸° -->
  <section class="section">
    <div class="sec-head">
      <h2>ì¸ê¸° ë ˆì‹œí”¼</h2>
      <div class="sort">
        <button class="pill is-active">ì¸ê¸°</button>
        <button class="pill">ìµœì‹ </button>
        <button class="pill">ë³„ì </button>
      </div>
    </div>
    <div class="grid" id="grid"></div>
  </section>

  <!-- íƒ­ë°” -->
  <nav class="tabbar" aria-label="í•˜ë‹¨ íƒ­ë°”">
    <a class="tab" href="menu.html" aria-label="ë©”ë‰´">
      <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#6b7280" stroke-width="2">
        <path d="M4 6h16M4 12h16M4 18h16"/>
      </svg>
    </a>
    <a class="tab is-active" href="liked.html" aria-label="ì¢‹ì•„ìš”">
      <svg viewBox="0 0 24 24" width="24" height="24" fill="#2E7D32">
        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5
               2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09
               C13.09 3.81 14.76 3 16.5 3
               19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55
               11.54L12 21.35z"/>
      </svg>
    </a>
    <a class="tab" href="search.html" aria-label="ê²€ìƒ‰">
      <div class="ring">
        <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="#6b7280" stroke-width="2">
          <circle cx="11" cy="11" r="7"/>
          <path d="M20 20l-3.5-3.5"/>
        </svg>
      </div>
    </a>
    <a class="tab" href="post-upload.html" aria-label="ì¶”ê°€">
      <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#6b7280" stroke-width="2">
        <path d="M12 5v14M5 12h14"/>
      </svg>
    </a>
    <a class="tab" href="profile.html" aria-label="í”„ë¡œí•„">
      <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#6b7280" stroke-width="2">
        <circle cx="12" cy="8" r="4"/>
        <path d="M4 20c2-4 14-4 16 0"/>
      </svg>
    </a>
  </nav>

</main>

<!-- ===== ìŠ¤í¬ë¦½íŠ¸ (ì¤‘ë³µ ì„ ì–¸ ì—†ìŒ) ===== -->
<script>
const BASE  = 'http://localhost:9999';
const PAGES = BASE + '/pages';
const PLACEHOLDER = 'https://placehold.co/1200x800?text=RECIPICK';

/* URL ìœ í‹¸ */
function toAbs(u){
  if (!u) return null;
  if (/^https?:\/\//i.test(u)) return u;
  if (u.startsWith('/')) return BASE + u;
  return `${BASE}/uploads/${u}`;
}
function safeEncode(raw){ return encodeURIComponent(String(raw).trim()).replace(/%5C/gi, ''); }
function proxyUrl(abs){ return abs ? `${BASE}/img-proxy?u=${safeEncode(abs)}` : null; }

/* ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ */
function testImage(url){
  return new Promise((resolve) => {
    const img = new Image();
    img.onload  = () => resolve(true);
    img.onerror = () => resolve(false);
    img.referrerPolicy = 'no-referrer';
    img.src = url;
  });
}
async function pickWorkingImage(raw){
  const direct = toAbs(raw);
  const candidates = [ proxyUrl(direct), direct, PLACEHOLDER ].filter(Boolean);
  for (const u of candidates) if (await testImage(u)) return u;
  return PLACEHOLDER;
}

/* ì¬ë£Œ ì¹´í…Œê³ ë¦¬ ë Œë” */
(function renderCategories(){
  const categories = [
    { name:'ì†Œê³ ê¸°', icon:'ğŸ¥©' }, { name:'ë¼ì§€ê³ ê¸°', icon:'ğŸ–' }, { name:'ë‹­ê³ ê¸°', icon:'ğŸ—' },
    { name:'ë‹¬ê±€/ìœ ì œí’ˆë¥˜', icon:'ğŸ¥š' }, { name:'ê³¡ë¥˜', icon:'ğŸŒ¾' },
    { name:'ê³¼ì¼ë¥˜', icon:'ğŸ' }, { name:'ê°€ê³µì‹í’ˆë¥˜', icon:'ğŸ¥«' }, { name:'ê±´ì–´ë¬¼ë¥˜', icon:'ğŸŸ' },
    { name:'ë²„ì„¯ë¥˜', icon:'ğŸ„' }, { name:'ë°€ê°€ë£¨', icon:'ğŸ§‚' }, { name:'ê³¡ë¥˜', icon:'ğŸš' },
    { name:'ì±„ì†Œë¥˜', icon:'ğŸ¥¦' }, { name:'ì½©/ê²¬ê³¼ë¥˜', icon:'ğŸ¥œ' }, { name:'í•´ë¬¼ë¥˜', icon:'ğŸ¦' },
  ];
  const grid = document.getElementById('categoryGrid');
  if (!grid) return;
  grid.innerHTML = categories.map(c => `
    <a class="category-item" href="${PAGES}/search.html?category=${encodeURIComponent(c.name)}" aria-label="${c.name}">
      <div class="cat-badge" aria-hidden="true">${c.icon}</div>
      <div class="category-name">${c.name}</div>
    </a>
  `).join('');
})();

/* ì •ë ¬ í† ê¸€ */
document.querySelectorAll('.pill').forEach(p=>{
  p.addEventListener('click',()=>{
    document.querySelectorAll('.pill').forEach(x=>x.classList.remove('is-active'));
    p.classList.add('is-active');
  });
});

/* ìºëŸ¬ì…€ ì œì–´ */
let currentSlide = 0, totalSlides = 0, autoSlideInterval;
function updateSlide(){
  const slides = document.getElementById('slides');
  const dots = document.querySelectorAll('.dot');
  slides.style.transform = `translateX(-${currentSlide*100}%)`;
  dots.forEach((d,i)=>d.classList.toggle('is-active', i===currentSlide));
}
function nextSlide(){ if(totalSlides>0){ currentSlide = (currentSlide+1)%totalSlides; updateSlide(); } }
function goToSlide(i){ currentSlide = i; updateSlide(); resetAutoSlide(); }
function resetAutoSlide(){ clearInterval(autoSlideInterval); if(totalSlides>1){ autoSlideInterval = setInterval(nextSlide, 4000); }}

/* ì˜¤ëŠ˜ì˜ ì¶”ì²œ */
(async () => {
  try {
    const r = await fetch(`${BASE}/api/home/featured`, { cache: 'no-store' });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    let list = await r.json();
    if (!Array.isArray(list) || !list.length) {
      list = [{ title:'ì¶”ì²œ ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤', imageUrl:null, minutes:20, level:'ë³´í†µ', rating:'4.5' }];
    }
    const slidesEl = document.getElementById('slides');
    slidesEl.innerHTML = list.map((it, i) => `
      <article class="slide" data-i="${i}">
        <div class="hero-thumb"></div>
        <div class="hero-meta">
          <div class="hero-title">${it.title ?? it.food_name ?? 'ë ˆì‹œí”¼'}</div>
          <div class="hero-sub">â­ ${it.rating ?? '4.5'} Â· ${(it.minutes ?? it.ckg_time ?? '20')}ë¶„ Â· ${it.level ?? it.ckg_level ?? 'ë³´í†µ'}</div>
        </div>
      </article>
    `).join('');
    await Promise.all(list.map(async (it, idx) => {
      const imgKey = it.imageUrl ?? it.rcp_img_url ?? it.rcpImgUrl ?? it.imgUrl ?? it.thumbnail;
      const good = await pickWorkingImage(imgKey);
      slidesEl.querySelector(`.slide[data-i="${idx}"] .hero-thumb`).style.backgroundImage = `url('${good}')`;
    }));
    const dotsWrap = document.querySelector('.dots');
    dotsWrap.innerHTML = list.map((_, i) =>
      `<button class="dot ${i===0?'is-active':''}" data-i="${i}" aria-label="${i+1}ë²ˆ"></button>`
    ).join('');
    document.querySelectorAll('.dot').forEach((d,i)=> d.addEventListener('click', ()=>goToSlide(i)));
    totalSlides = list.length;
    currentSlide = 0;
    updateSlide();
    resetAutoSlide();
  } catch (err) {
    console.error('[featured] load failed:', err);
    const slides = document.getElementById('slides');
    slides.innerHTML = `
      <article class="slide">
        <div class="hero-thumb" style="background-image:url('${PLACEHOLDER}')"></div>
        <div class="hero-meta">
          <div class="hero-title">ì¶”ì²œì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”</div>
          <div class="hero-sub">ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” ë°ì´í„° ë¬¸ì œì¼ ìˆ˜ ìˆì–´ìš”</div>
        </div>
      </article>`;
    document.querySelector('.dots').innerHTML = `<button class="dot is-active" data-i="0" aria-label="1ë²ˆ"></button>`;
    totalSlides = 1; currentSlide = 0; updateSlide();
  }
})();

/* ì¸ê¸° ë ˆì‹œí”¼ */
(async () => {
  try {
    const r = await fetch(`${BASE}/api/recipes/popular?limit=8`, { cache: 'no-store' });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const items = await r.json();
    const list = Array.isArray(items) && items.length ? items : [{
      title:'ìƒ˜í”Œ ë ˆì‹œí”¼', imageUrl:null, likes:0, minutes:20, id:''
    }];
    const grid = document.getElementById('grid');
    grid.innerHTML = list.map((it, i) => {
      const id  = it.id ?? it.post_id ?? it.postId ?? '';
      const href = `${PAGES}/recipe-detail.html${id ? `?id=${id}` : ''}`;
      return `
        <a class="card" href="${href}" data-i="${i}">
          <div class="thumb"></div>
          <div class="meta">
            <div class="title">${it.title ?? it.food_name ?? 'ë ˆì‹œí”¼'}</div>
            <div class="sub">â¤ï¸ ${it.likes ?? it.like_count ?? it.likeCount ?? 0} Â· ${(it.minutes ?? it.ckg_time ?? '20')}ë¶„</div>
          </div>
        </a>`;
    }).join('');
    await Promise.all(list.map(async (it, idx) => {
      const imgKey = it.imageUrl ?? it.rcp_img_url ?? it.rcpImgUrl ?? it.imgUrl ?? it.thumbnail;
      const good = await pickWorkingImage(imgKey);
      grid.querySelector(`.card[data-i="${idx}"] .thumb`).style.backgroundImage = `url('${good}')`;
    }));
  } catch (err) {
    console.error('[popular] load failed:', err);
  }
})();
</script>

</body>
</html>
