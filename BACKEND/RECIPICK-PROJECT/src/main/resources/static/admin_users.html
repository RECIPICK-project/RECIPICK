<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin · 사용자 관리</title>
  <link rel="stylesheet" href="css/tokens.css" />
  <link rel="stylesheet" href="css/components.css" />
  <link rel="stylesheet" href="css/admin.css" />
  <link rel="stylesheet" href="css/admin_users.css" />
  <script defer src="js/theme.js"></script>
</head>
<body class="admin">
<div class="admin-layout">
  <!-- 사이드바 -->
  <aside class="side">
    <div class="logo">LOGO</div>
    <nav class="sidemenu">
      <a class="m" href="admin.html">대시보드</a>
      <a class="m" href="admin_reports.html">신고 관리</a>
      <a class="m" href="admin_recipes.html">레시피/댓글 관리</a>
      <a class="m active" href="admin_users.html">유저 관리</a>
      <a class="m" href="admin_settings.html">세팅</a>
    </nav>
  </aside>

  <!-- 보드 -->
  <main class="board">
    <div class="topbar">
      <h1>사용자 관리</h1>
      <div class="actions">
        <input class="input" type="search" id="search" placeholder="이메일/닉네임 검색" />
        <button class="btn" id="searchBtn">검색</button>
      </div>
    </div>

    <!-- 📌 강조: 신고 많은 유저 필터 -->
    <section class="card" aria-labelledby="riskTitle">
      <h2 class="card-title" id="riskTitle">리스크 필터</h2>
      <div class="pills">
        <button class="pill is-active" data-filter="all">전체</button>
        <button class="pill" data-filter="reported">신고 다수(≥3)</button>
        <button class="pill" data-filter="lowPoint">포인트 저점(≤0)</button>
      </div>
      <p class="desc">신고 누적·포인트 상태로 빠르게 선별하세요. 신고 임계값은 정책에서 조정 가능합니다.</p>
    </section>

    <!-- 📌 유저 리스트 -->
    <section class="card" aria-labelledby="listTitle">
      <h2 class="card-title" id="listTitle">사용자 목록</h2>
      <div class="user-list">
        <ul id="userList">
          <!-- 예시 아이템 (실제에선 백에서 주는 데이터로 렌더) -->
          <li class="user-item" data-uid="u_1021" data-reports="4" data-points="-12" data-tier="Bronze">
            <div class="user-main">
              <div class="user-title">홍길동 · user@mail.com</div>
              <div class="user-meta">
                <span>UID: u_1021</span>
                <span>가입일: 2025-07-12</span>
                <span>포인트: <strong class="u-point">-12</strong></span>
                <span>신고 누적: <strong class="u-report">4</strong>건</span>
              </div>
            </div>
            <div class="user-right">
              <span class="badge tier js-tier">Bronze</span>
              <span class="badge warn js-flag" title="신고 다수">신고주의</span>
              <button class="btn-ghost small js-view">보기</button>
              <button class="btn-ghost small js-edit" data-open="userModal">수정</button>
            </div>
          </li>

          <li class="user-item" data-uid="u_1500" data-reports="0" data-points="680" data-tier="Gold">
            <div class="user-main">
              <div class="user-title">김레시 · kim@cook.com</div>
              <div class="user-meta">
                <span>UID: u_1500</span>
                <span>가입일: 2025-03-02</span>
                <span>포인트: <strong class="u-point">680</strong></span>
                <span>신고 누적: <strong class="u-report">0</strong>건</span>
              </div>
            </div>
            <div class="user-right">
              <span class="badge tier js-tier">Gold</span>
              <span class="badge ok">우수</span>
              <button class="btn-ghost small js-view">보기</button>
              <button class="btn-ghost small js-edit" data-open="userModal">수정</button>
            </div>
          </li>

          <li class="user-item" data-uid="u_990" data-reports="2" data-points="120" data-tier="Silver">
            <div class="user-main">
              <div class="user-title">박댓글 · reply@site.com</div>
              <div class="user-meta">
                <span>UID: u_990</span>
                <span>가입일: 2025-06-01</span>
                <span>포인트: <strong class="u-point">120</strong></span>
                <span>신고 누적: <strong class="u-report">2</strong>건</span>
              </div>
            </div>
            <div class="user-right">
              <span class="badge tier js-tier">Silver</span>
              <button class="btn-ghost small js-view">보기</button>
              <button class="btn-ghost small js-edit" data-open="userModal">수정</button>
            </div>
          </li>
        </ul>
      </div>
    </section>

    <!-- 📌 등급/토큰/포인트 정책 (로컬 저장) -->
    <section class="card" aria-labelledby="policyTitle">
      <h2 class="card-title" id="policyTitle">등급/토큰/포인트 정책</h2>
      <p class="desc">등급별 AI 토큰 한도와 포인트 규칙을 설정합니다. 저장 시 로컬에 보관됩니다.</p>
      <div class="form-grid">
        <div class="row">
          <label>Bronze 토큰/일</label>
          <input class="input" id="tokBronze" type="number" min="0" step="10" value="200" style="max-width:140px"/>
        </div>
        <div class="row">
          <label>Silver 토큰/일</label>
          <input class="input" id="tokSilver" type="number" min="0" step="10" value="500" style="max-width:140px"/>
        </div>
        <div class="row">
          <label>Gold 토큰/일</label>
          <input class="input" id="tokGold" type="number" min="0" step="10" value="1000" style="max-width:140px"/>
        </div>

        <div class="row">
          <label>댓글 1개</label>
          <input class="input" id="ptComment" type="number" min="0" step="1" value="1" style="max-width:140px"/>
        </div>
        <div class="row">
          <label>레시피 등록</label>
          <input class="input" id="ptRecipe" type="number" min="0" step="1" value="10" style="max-width:140px"/>
        </div>
        <div class="row">
          <label>승격 보너스</label>
          <input class="input" id="ptPromote" type="number" min="0" step="1" value="100" style="max-width:140px"/>
        </div>

        <div class="row">
          <label>신고 임계(주의)</label>
          <input class="input" id="reportThreshold" type="number" min="1" step="1" value="3" style="max-width:140px"/>
        </div>

        <div class="row" style="grid-column:1/-1">
          <div class="actions">
            <button class="btn" id="savePolicy">저장</button>
            <button class="btn-ghost" id="resetPolicy">초기화</button>
            <span class="badge ok" id="policySaved" style="display:none">저장됨</span>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- 사용자 수정 모달 -->
<div class="modal" id="userModal" aria-hidden="true">
  <div class="overlay" data-close></div>
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="userTitle">
    <div class="dialog-head">
      <h3 id="userTitle">사용자 정보</h3>
      <button class="close" data-close aria-label="닫기">×</button>
    </div>
    <div class="dialog-body">
      <div class="row"><strong style="min-width:88px; color:var(--muted)">UID</strong> <span id="mUid">-</span></div>
      <div class="row"><strong style="min-width:88px; color:var(--muted)">닉네임</strong> <span id="mName">-</span></div>
      <div class="row"><strong style="min-width:88px; color:var(--muted)">이메일</strong> <span id="mMail">-</span></div>

      <label class="row">
        <span style="min-width:88px; color:var(--muted)">등급</span>
        <select class="input" id="mTier" style="max-width:160px">
          <option>Bronze</option>
          <option>Silver</option>
          <option>Gold</option>
        </select>
      </label>

      <label class="row">
        <span style="min-width:88px; color:var(--muted)">포인트</span>
        <input class="input" id="mPoint" type="number" step="1" style="max-width:140px" />
      </label>

      <div class="row col" style="gap:6px">
        <strong style="min-width:88px; color:var(--muted)">신고</strong>
        <div id="mReports" class="soft" style="background:#F9FBE7; border:1px solid var(--line); border-radius:8px; padding:10px">
          최근 30일: 0건
        </div>
      </div>
    </div>
    <div class="dialog-foot">
      <button class="btn-ghost" data-close>취소</button>
      <button class="btn success" id="saveUser">저장</button>
    </div>
  </div>
</div>

<script>
  (() => {
    // ===== 로컬 키
    const KEY_POLICY = 'userPolicy';

    // ===== 헬퍼
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
    const getPolicy = () => {
      try{ return JSON.parse(localStorage.getItem(KEY_POLICY)) }catch(e){ return null }
    };
    const setPolicy = (p) => localStorage.setItem(KEY_POLICY, JSON.stringify(p));

    // ===== 정책 초기 렌더
    const defaultPolicy = {
      tokens: { Bronze:200, Silver:500, Gold:1000 },
      points: { comment:1, recipe:10, promote:100 },
      reportThreshold: 3
    };
    function renderPolicyForm(p){
      $('#tokBronze').value = p.tokens.Bronze;
      $('#tokSilver').value = p.tokens.Silver;
      $('#tokGold').value = p.tokens.Gold;
      $('#ptComment').value = p.points.comment;
      $('#ptRecipe').value = p.points.recipe;
      $('#ptPromote').value = p.points.promote;
      $('#reportThreshold').value = p.reportThreshold;
    }
    const policy = getPolicy() || defaultPolicy;
    renderPolicyForm(policy);

    // ===== 정책 저장/초기화
    $('#savePolicy').addEventListener('click', ()=>{
      const p = {
        tokens:{
          Bronze:+$('#tokBronze').value,
          Silver:+$('#tokSilver').value,
          Gold:+$('#tokGold').value
        },
        points:{
          comment:+$('#ptComment').value,
          recipe:+$('#ptRecipe').value,
          promote:+$('#ptPromote').value
        },
        reportThreshold:+$('#reportThreshold').value
      };
      setPolicy(p);
      $('#policySaved').style.display='inline-block';
      setTimeout(()=> $('#policySaved').style.display='none', 1500);
      applyFlags(); // 신고주의 배지 갱신
    });
    $('#resetPolicy').addEventListener('click', ()=>{
      setPolicy(defaultPolicy);
      renderPolicyForm(defaultPolicy);
      applyFlags();
    });

    // ===== 리스트 필터/검색
    function matchesFilter(li, active){
      const pts = +$('.u-point', li).textContent;
      const reps = +$('.u-report', li).textContent;
      if(active==='reported') return reps >= (getPolicy()?.reportThreshold ?? 3);
      if(active==='lowPoint') return pts <= 0;
      return true;
    }
    function filterList(){
      const active = $('.pill.is-active')?.dataset.filter || 'all';
      const q = $('#search').value.trim().toLowerCase();
      $$('#userList .user-item').forEach(li=>{
        const text = li.innerText.toLowerCase();
        const ok = matchesFilter(li, active) && (!q || text.includes(q));
        li.style.display = ok ? '' : 'none';
      });
    }
    $$('.pill').forEach(p=>{
      p.addEventListener('click', ()=>{
        $$('.pill').forEach(x=>x.classList.remove('is-active'));
        p.classList.add('is-active');
        filterList();
      });
    });
    $('#searchBtn').addEventListener('click', filterList);

    // ===== 신고주의/우수 배지 표시
    function applyFlags(){
      const thresh = getPolicy()?.reportThreshold ?? 3;
      $$('#userList .user-item').forEach(li=>{
        const reps = +li.dataset.reports;
        const flag = $('.js-flag', li);
        if(reps >= thresh){
          if(!flag){
            const span = document.createElement('span');
            span.className = 'badge warn js-flag';
            span.textContent = '신고주의';
            $('.user-right', li).insertBefore(span, $('.js-view', li));
          }else{
            flag.className = 'badge warn js-flag';
            flag.textContent = '신고주의';
          }
        }else{
          if(flag) flag.remove();
          // 우수 배지는 포인트 등 기준으로 커스텀 가능(샘플은 Gold에만 표시)
          if($('.js-tier', li)?.textContent === 'Gold'){
            if(!$('.badge.ok', li)){
              const ok = document.createElement('span');
              ok.className = 'badge ok';
              ok.textContent = '우수';
              $('.user-right', li).insertBefore(ok, $('.js-view', li));
            }
          }
        }
      });
    }
    applyFlags();

    // ===== 사용자 모달
    let currentLi = null;
    $$('#userList .js-edit').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        currentLi = e.target.closest('.user-item');
        const uid = currentLi.dataset.uid;
        const name = $('.user-title', currentLi).textContent.split(' · ')[0];
        const mail = $('.user-title', currentLi).textContent.split(' · ')[1] || '-';
        const tier = $('.js-tier', currentLi).textContent;
        const pts = +$('.u-point', currentLi).textContent;
        const reps = +$('.u-report', currentLi).textContent;

        $('#mUid').textContent = uid;
        $('#mName').textContent = name;
        $('#mMail').textContent = mail;
        $('#mTier').value = tier;
        $('#mPoint').value = pts;
        $('#mReports').textContent = `최근 30일: ${reps}건`;

        $('#userModal').setAttribute('aria-hidden','false');
        document.documentElement.style.overflow = 'hidden';
      });
    });
    // 열기
    function openUserModal(){
      document.getElementById('userModal').setAttribute('aria-hidden','false');
      // 스크롤 락
      document.documentElement.style.overflow = 'hidden';
    }
    // 닫기
    function closeUserModal(){
      document.getElementById('userModal').setAttribute('aria-hidden','true');
      document.documentElement.style.overflow = '';
    }

    // 트리거 연결 (기존 이벤트에서 open/close만 바꿔 주면 됨)
    document.querySelectorAll('#userModal [data-close]').forEach(btn=>{
      btn.addEventListener('click', closeUserModal);
    });
    // 예: 수정 버튼 클릭 시
    document.querySelectorAll('#userList .js-edit').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        // ...데이터 바인딩...
        openUserModal();
      });
    });

    // 보기(더미)
    $$('#userList .js-view').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const li = e.target.closest('.user-item');
        alert(`사용자 상세(더미): ${li.dataset.uid}`);
      });
    });

    // 닫기
    $$('#userModal [data-close]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $('#userModal').setAttribute('aria-hidden','true');
        document.documentElement.style.overflow = '';
      });
    });

    // 저장 → UI 반영
    $('#saveUser').addEventListener('click', ()=>{
      if(!currentLi) return;
      const newTier = $('#mTier').value;
      const newPts = +$('#mPoint').value;

      $('.js-tier', currentLi).textContent = newTier;
      $('.u-point', currentLi).textContent = newPts;

      // 우수/신고주의 뱃지 갱신
      applyFlags();

      $('#userModal').setAttribute('aria-hidden','true');
      document.documentElement.style.overflow = '';
    });

    // 초기 필터 적용
    filterList();
  })();
</script>
</body>
</html>
