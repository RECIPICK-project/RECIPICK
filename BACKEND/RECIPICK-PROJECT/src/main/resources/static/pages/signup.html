<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>íšŒì›ê°€ì…</title>
  <link rel="stylesheet" href="../css/signup.css">
</head>

<body>

  <main class="phone" role="main" aria-label="íšŒì›ê°€ì… í™”ë©´">
    <button class="back" aria-label="ë’¤ë¡œ ê°€ê¸°" type="button" onclick="history.back()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M15 6l-6 6 6 6" stroke="#111827" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
    </button>

    <div class="wrap">
      <div class="title">íšŒì›ê°€ì…</div>

      <div class="group">
        <label class="label" for="nickname">ë‹‰ë„¤ì„</label>
        <div class="row">
          <input id="nickname" class="input" type="text" placeholder="ë‹‰ë„¤ì„" aria-label="ë‹‰ë„¤ì„" />
          <button id="checkNicknameBtn" class="check" type="button">ì¤‘ë³µí™•ì¸</button>
        </div>
        <span id="nicknameMsg"></span>
      </div>

      <div class="group">
        <label class="label" for="email">ì´ë©”ì¼</label>
        <div class="row">
          <input id="email" class="input" type="email" inputmode="email" placeholder="example@mail.com"
            aria-label="ì´ë©”ì¼" />
          <button id="checkEmailBtn" class="check" type="button">ì¤‘ë³µí™•ì¸</button>
        </div>
        <span id="emailMsg"></span>
      </div>

      <div class="group">
        <label class="label" for="pw">ë¹„ë°€ë²ˆí˜¸</label>
        <input id="pw" class="input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" aria-label="ë¹„ë°€ë²ˆí˜¸" />
        <input id="pw2" class="input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" aria-label="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" />
      </div>

      <p id="errorMsg" style="color:red; text-align:center;"></p>

      <div class="cta">
        <button id="signupBtn" class="submit" type="button">ê°€ì…í•˜ê¸°</button>
      </div>

      <p class="tos">
        ê°€ì…í•˜ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ë©´
        <a href="terms.html" target="_blank">ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€</a> ë°
        <a href="privacy.html" target="_blank">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</a>
        ì— ë™ì˜í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.
      </p>

      <div class="spacer"></div>
    </div>
  </main>


  <script>
    const BASE_API = "";

    let isEmailValid = false;
    let isNicknameValid = false;

    // ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸
    document.getElementById("checkEmailBtn").addEventListener("click", async () => {
      const email = document.getElementById("email").value.trim().toLowerCase();
      const emailMsg = document.getElementById("emailMsg");
      emailMsg.textContent = "";
      isEmailValid = false;

      if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
        emailMsg.textContent = "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.";
        emailMsg.style.color = "red";
        return;
      }
      const res = await fetch(`${BASE_API}/api/users/check-email?email=${encodeURIComponent(email)}`);
      const data = await res.json();
      if (data.exists) {
        emailMsg.textContent = "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.";
        emailMsg.style.color = "red";
      } else {
        emailMsg.textContent = "ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë©”ì¼ì…ë‹ˆë‹¤.";
        emailMsg.style.color = "green";
        isEmailValid = true;
      }
    });

    // ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸
    document.getElementById("checkNicknameBtn").addEventListener("click", async () => {
      const nickname = document.getElementById("nickname").value.trim();
      const nicknameMsg = document.getElementById("nicknameMsg");
      nicknameMsg.textContent = "";
      isNicknameValid = false;

      if (!nickname) {
        nicknameMsg.textContent = "ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.";
        nicknameMsg.style.color = "red";
        return;
      }
      if (!/^[ê°€-í£]+$/.test(nickname)) {
        nicknameMsg.textContent = "ë‹‰ë„¤ì„ì€ í•œê¸€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
        nicknameMsg.style.color = "red";
        return;
      }

      const res = await fetch(`${BASE_API}/api/users/check-nickname?nickname=${encodeURIComponent(nickname)}`);
      const data = await res.json();
      if (data.exists) {
        nicknameMsg.textContent = "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.";
        nicknameMsg.style.color = "red";
      } else {
        nicknameMsg.textContent = "ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.";
        nicknameMsg.style.color = "green";
        isNicknameValid = true;
      }
    });

    // ê°€ì…í•˜ê¸° â†’ ì´ë©”ì¼ ë°œì†¡ ì„±ê³µ ì‹œ ì¸ì¦ í˜ì´ì§€ë¡œ ì´ë™
    document.getElementById("signupBtn").addEventListener("click", async (e) => {
      const email = document.getElementById("email").value.trim().toLowerCase();
      const password = document.getElementById("pw").value;
      const confirmPassword = document.getElementById("pw2").value;
      const nickname = document.getElementById("nickname").value.trim();
      const errorMsg = document.getElementById("errorMsg");

      errorMsg.textContent = "";

      if (!isEmailValid) { errorMsg.textContent = "ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ì„ í•´ì£¼ì„¸ìš”."; return; }
      if (!isNicknameValid) { errorMsg.textContent = "ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸ì„ í•´ì£¼ì„¸ìš”."; return; }
      if (password !== confirmPassword) { errorMsg.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."; return; }
      const regex = /^(?=.*[A-Z])(?=.*[!@#$])(?=.*[0-9])[A-Za-z0-9!@#$]{1,10}$/;
      if (!regex.test(password)) {
        errorMsg.textContent = "ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸+ìˆ«ì 10ì ì´ë‚´, ëŒ€ë¬¸ì 1ê°œ ì´ìƒ, !,@,#,$ ì¤‘ í•˜ë‚˜ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.";
        return;
      }

      const btn = e.currentTarget;
      btn.disabled = true;

      try {
        const res = await fetch(`${BASE_API}/api/auth/email/send?email=${encodeURIComponent(email)}`, { method: 'POST' });

        if (!res.ok) {
          const t = await res.text();
          errorMsg.textContent = t || `ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨ (HTTP ${res.status})`;
          return;
        }

        // ğŸ‘‰ ì¸ì¦í˜ì´ì§€ë¡œ ì´ë™í•˜ê¸° ì „ì— ì„ì‹œ ì €ì¥(ë¹„ë²ˆ/ë‹‰ë„¤ì„ì„ URLì— ì‹£ì§€ ì•Šê¸° ìœ„í•¨)
        sessionStorage.setItem("pendingSignup", JSON.stringify({ email, password, nickname }));

        // ğŸ‘‰ ì¸ì¦ í˜ì´ì§€ë¡œ ì´ë™ (ì¿¼ë¦¬ì—ëŠ” ì´ë©”ì¼ë§Œ)
        location.href = `email-verification.html?email=${encodeURIComponent(email)}`;

      } catch (err) {
        console.error(err);
        errorMsg.textContent = "ì´ë©”ì¼ ë°œì†¡ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      } finally {
        btn.disabled = false;
      }
    });
  </script>

</body>

</html>
