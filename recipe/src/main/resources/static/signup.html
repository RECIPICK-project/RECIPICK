<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>회원가입</title>
</head>
<body>
<h1>회원가입</h1>
<form id="signupForm">
    이메일: <input type="email" id="email" required><br>
    비밀번호: <input type="password" id="password" required><br>
    비밀번호 확인: <input type="password" id="confirmPassword" required><br>
    닉네임: <input type="text" id="nickname" required>
    <button type="button" id="checkNicknameBtn">중복 확인</button>
    <span id="nicknameMsg"></span><br>
    <button type="submit">회원가입</button>
</form>

<!-- 이메일 인증 창 -->
<div id="emailVerification" style="display:none; margin-top:20px;">
    <p>이메일로 발송된 6자리 코드를 입력하세요.</p>
    <input type="text" id="verificationCode" maxlength="6">
    <button type="button" id="verifyBtn">인증 확인</button>
    <span id="verifyMsg"></span>
</div>

<p id="errorMsg" style="color:red;"></p>

<script>
    const form = document.getElementById('signupForm');
    const errorMsg = document.getElementById('errorMsg');
    const checkBtn = document.getElementById("checkNicknameBtn");
    const nicknameInput = document.getElementById("nickname");
    const nicknameMsg = document.getElementById("nicknameMsg");
    let isNicknameValid = false;

    // 닉네임 중복 확인
    checkBtn.addEventListener("click", async () => {
        const nickname = nicknameInput.value.trim();
        if (!nickname) { nicknameMsg.innerText="닉네임을 입력하세요."; nicknameMsg.style.color="red"; isNicknameValid=false; return; }
        if (!/^[가-힣]+$/.test(nickname)) { nicknameMsg.innerText="닉네임은 한글만 가능합니다."; nicknameMsg.style.color="red"; isNicknameValid=false; return; }

        const res = await fetch('http://localhost:9999/api/users/check-nickname?nickname='+nickname);
        const data = await res.json();
        if(data.exists){ nicknameMsg.innerText="사용 중인 닉네임"; nicknameMsg.style.color="red"; isNicknameValid=false; }
        else{ nicknameMsg.innerText="사용 가능한 닉네임"; nicknameMsg.style.color="green"; isNicknameValid=true; }
    });

    // 회원가입 버튼 클릭
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const nickname = nicknameInput.value.trim();

        // 1. 비밀번호 확인
        if(password !== confirmPassword){ errorMsg.innerText="비밀번호가 일치하지 않습니다."; return; }

        // 2. 비밀번호 유효성 체크
        const regex = /^(?=.*[A-Z])(?=.*[!@#$])(?=.*[0-9])[A-Za-z0-9!@#$]{1,10}$/;
        if(!regex.test(password)) {
            errorMsg.innerText = "비밀번호는 영문+숫자 10자 이내, 대문자 1개 이상, !,@,#,$ 중 하나를 포함해야 합니다.";
            return;
}

        // 3. 닉네임 체크
        if(!isNicknameValid){ errorMsg.innerText="닉네임 중복 확인 필요"; return; }

        // 4. 이메일 인증 코드 발송
        try {
            await fetch(`http://localhost:9999/api/auth/email/send?email=${email}`, { method:'POST' });
            alert("이메일로 인증 코드가 발송되었습니다!");
            document.getElementById('emailVerification').style.display = 'block';
        } catch(err){ console.error(err); errorMsg.innerText="이메일 발송 실패"; return; }
    });

    // 인증 확인 버튼
    document.getElementById("verifyBtn").addEventListener("click", async () => {
        const code = document.getElementById("verificationCode").value.trim();
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;
        const nickname = nicknameInput.value.trim();

        try{
            const res = await fetch(`http://localhost:9999/api/auth/email/verify?email=${email}&code=${code}`, { method:'POST' });
            const text = await res.text();
            const msg = document.getElementById("verifyMsg");
            msg.innerText = text;
            msg.style.color = res.ok ? "green":"red";

            if(res.ok){
                // 인증 성공 시 회원가입 API 호출
                const signupRes = await fetch('http://localhost:9999/api/users/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, nickname })
                });
                if(signupRes.ok){
                    alert("회원가입 완료! 로그인 페이지로 이동합니다.");
                    window.location.href="/login.html";
                } else {
                    alert("회원가입 실패");
                }
            }
        } catch(err){ console.error(err); errorMsg.innerText="인증 중 오류 발생"; }
    });
</script>
</body>
</html>